<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=EUC-JP">
  <title>Kwartzユーザーズガイド</title>
  <meta name="author" content="Makoto Kuwata &lt;kwa(at)kuwata-lab.com&gt;">
  <meta name="generator" content="kwaser">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <link rel="stylesheet" href="docstyle.css" type="text/css">
 </head>
 <body>

  <blockquote>
   <div class="mainbody">

    <div align="left"><h1>Kwartzユーザーズガイド</h1></div>
    <div align="left">
      Makoto Kuwata &lt;kwa(at)kuwata-lab.com&gt;<br>
      last update: $Date$<br>
    </div>

<a name="preface"></a>
<h2 class="section1">はじめに</h2>
<p>このドキュメントは、テンプレートシステムKwartz<sup>(<a href="#fnref:1" name="fnlink:1">*1</a>)</sup>のユーザーズガイドです。
Kwartzは、『プレゼンテーションロジックとプレゼンテーションデータの分離(Separation of Presentation Logic and Presentation Data, SoPL/PD)』または『プレゼンテーションロジックの独立(Independence of Presentation Logic)』という概念を実現したテンプレートシステムです。
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:1" href="#fnlink:1">*1</a>)</dt>
  <dd>Kwartzの開発は、<a href="http://www.ipa.go.jp/">情報処理推進機構(IPA)</a>による平成15年度<a href="http://www.ipa.go.jp/jinzai/esp/">未踏ソフトウェア創造事業</a>の支援を受けました。</dd>
 </dl>
</div>
<a name="toc"></a>
<h3 class="section2">目次</h3>
<ul>
  <li><a href="#preface">はじめに</a>
  <ul>
    <li><a href="#toc">目次</a>
    </li>
  </ul>
  </li>
  <li><a href="#intro">Kwartzについて</a>
  <ul>
    <li><a href="#whatis">Kwartzとは？</a>
    </li>
    <li><a href="#features">特徴</a>
    </li>
    <li><a href="#example1">簡単な例</a>
    </li>
    <li><a href="#example2">複雑な例</a>
    </li>
    <li><a href="#pattern">プレゼンテーションロジックの応用例</a>
    </li>
  </ul>
  </li>
  <li><a href="#directives">ディレクティブ</a>
  </li>
  <li><a href="#sanitize">サニタイズ</a>
  <ul>
    <li><a href="#sanitize1">自動サニタイズ</a>
    </li>
    <li><a href="#sanitize2">部分サニタイズ</a>
    </li>
    <li><a href="#sanitize3">サニタイズの設定</a>
    </li>
  </ul>
  </li>
  <li><a href="#topics">その他の話題</a>
  <ul>
    <li><a href="#restriction">制限事項</a>
    </li>
    <li><a href="#analyze">グローバル変数とローカル変数</a>
    </li>
    <li><a href="#rename">テンプレートグローバル/ローカル変数の名前を変更する</a>
    </li>
    <li><a href="#span">spanタグの削除</a>
    </li>
    <li><a href="#topics-append">開始タグに式の値を追加する</a>
    </li>
    <li><a href="#rawcode">プレゼンテーションロジックをターゲット言語で記述する</a>
    </li>
    <li><a href="#rails">Ruby on Railsで使用する</a>
    </li>
    <li><a href="#topic-defun">テンプレートをRubyまたはPHPの関数にコンパイルする</a>
    </li>
  </ul>
  </li>
</ul>
<br>


<br>


<a name="intro"></a>
<h2 class="section1">Kwartzについて</h2>
<a name="whatis"></a>
<h3 class="section2">Kwartzとは？</h3>
<p>Kwartz<sup>(<a href="#fnref:2" name="fnlink:2">*2</a>)</sup>とは、
<b>『プレゼンテーションロジックとプレゼンテーションデータの分離(Separation of Presentation Logic and Presentaion Data(SoPL/PD)』</b>という概念を実現したテンプレートシステムです。
</p>
<p>Kwartz-rubyは、RubyによるKwartzの実装です。
このほか、PHPやJavaによる実装も予定されています。
</p>
<p>以降の説明では、「Kwartz」という言葉はテンプレートシステムの仕様を説明するときに使用し、
「Kwartz-ruby」という言葉は特定の実装について説明するときに使用します。
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:2" href="#fnlink:2">*2</a>)</dt>
  <dd>Kwartzは'Quartz'と同じように発音してください。</dd>
 </dl>
</div>
<br>


<a name="features"></a>
<h3 class="section2">特徴</h3>
<p>Kwartzには次のような特徴があります。
</p>
<dl class="dl2">
<dt class="dt2">
プレゼンテーションデータとプレゼンテーションロジックとが分離可能</dt>
<dd class="dd2">
<p>	通常のテンプレートシステムではテンプレートとメインプログラムとを分離します。
	Kwartzでは更に、テンプレートをプレゼンテーションデータとプレゼンテーションロジックとに分離します。
	これにより、プレゼンテーションロジックがHTMLの中に混じることも、またメインプログラムに紛れ込むこともありません。
</p>
</dd>
<dt class="dt2">
高速な動作</dt>
<dd class="dd2">
<p>	Kwartzでは、テンプレート（プレゼンテーションデータとプレゼンテーションロジック）から出力用スクリプトを生成します。
	これをあらかじめ行っておくため、実行時には出力用プログラムを呼び出すだけでよく、極めて高速に動作します。
	またDOMツリーのような木構造を使わずに済むため、他のテンプレートシステムよりも高速です。
</p>
</dd>
<dt class="dt2">
複数のプログラミング言語に対応</dt>
<dd class="dd2">
<p>	Kwartzは内部で独自の中間言語を採用することにより、様々なプログラミング言語から使用できるようになっています。
	つまり、ひとつのHTMLテンプレートを様々な言語から使用することができるのです。
	また使用する言語を変えたとしても、プレゼンテーション層は何も変更する必要がありません。
	現在のところ、Ruby(eRuby)、PHP、JSP(JSTL 1.1&amp;1.0)、Velocityに対応しています。
</p>
</dd>
<dt class="dt2">
HTMLテンプレートがSGML形式を崩さない</dt>
<dd class="dd2">
<p>	Kwartzでは、HTMLテンプレートにおけるマーキング（印付け）をid属性で行っています。
	そのため、 <a href="http://smarty.php.net/">Smarty</a> や
	<a href="http://jakarta.apache.org/velocity/">Jakarta Velocity</a> 
	のようにHTMLテンプレートのデザインを崩してしまうことがありません。
</p>
</dd>
<dt class="dt2">
任意のテキストファイルで使用可能</dt>
<dd class="dd2">
<p>	Kwartzでは、専用の属性がついたタグのみを認識し、それ以外のタグはただのプレーンテキストとみなします。
	またHTMLパーサーやXMLパーサーを使用せず、独自に解析を行っています。
	そのため、<a href="http://xmlc.objectweb.org/">Enhydra XMLC</a> や
	<a href="http://amrita.sourceforge.jp/">amrita</a> 
	のようにXMLやHTMLでしか使用できないということはなく、任意のテキストファイルで使用可能です。
</p>
</dd>
<dt class="dt2">
自動サニタイズと部分サニタイズ</dt>
<dd class="dd2">
<p>	Kwartzでは、サニタイズを自動的に行うようにすることができます。
	つまり、いちいち「CGI.escapeHTML(var)」や「<code>htmlspecialchars($var)</code>」と書く必要がありません。
	またサニタイズ機能はオン/オフすることができます。
	さらに、ある部分だけをサニタイズする/しないを細かく指定できます。
</p>
</dd>
</dl>
<br>


<a name="example1"></a>
<h3 class="section2">簡単な例</h3>
<p>Kwartzは、テンプレートをプレゼンテーションデータとプレゼンテーションロジックとに分けて記述します。
ここではその例を示します。
</p>
<p>まずプレゼンテーションデータの例です。
</p>
<ul type="disc">
<li>「<code>id="list"</code>」はそのエレメントにvaluesという名前で「目印」をつけること、つまり操作対象とすることを表します。Kwartzでは、エレメントに目印をつけることを「マーキング(Marking)」といいます。
</li>
<li>同様に、「<code>id="item"</code>」は&lt;td&gt;エレメントにitemという名前で「目印」をつけています。
</li>
</ul>
<p>プレゼンテーションデータ(example1.html)：
</p>
<a name="example1.html"></a>
<pre class="program">&lt;table&gt;
  &lt;tr <b>id="list"</b>&gt;
    &lt;td <b>id="item"</b>&gt;foo&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>次はプレゼンテーションロジックの例です。
プレゼンテーションロジックでは、プレゼンテーションデータにつけた「目印」に対して操作を行います。
</p>
<ul type="disc">
<li>「<code>#item { ... }</code>」は目印「item」がつけられたエレメント（Element, ここでは<code>&lt;td&gt;</code>から<code>&lt;t/d&gt;</code>まで）を表します。
    <ul type="circle">
    <li>「<code>value: <i>expression</i>;</code>」は、エレメントの内容を式<code><i>expression</i></code>の値（ここでは変数<code>member</code>の値）で置き換えることを表します。
    </li>
    <li>「<code>remove: "id";</code>」は、エレメントからid属性を取り除くことを表します。
       なお「<code>id="<i>name</i></code>"」のかわりに「<code>id="mark:<i>name</i>"</code>」を使用するとid属性は自動的に削除され、「<code>remove: "id";</code>」をいちいち記述する必要はなくなります。
    </li>
    </ul>
</li>
<li>「<code>#list { ... }</code>」は目印「list」がつけられたエレメント（Element, ここでは<code>&lt;tr&gt;</code>から<code>&lt;/tr&gt;</code>まで）を表します。
    <ul type="circle">
    <li>「<code>plogic: { ... }</code>」で、そのエレメントのプレゼンテーションロジックを定義します。
    </li>
    <li>「<code>@stag</code>」は開始タグ（Start tag, ここでは<code>&lt;tr&gt;</code>）を表します。
    </li>
    <li>「<code>@cont</code>」は内容（Content, ここでは<code>&lt;td id="item"&gt;foo&lt;/td&gt;</code>）を表します。
    </li>
    <li>「<code>@etag</code>」は終了タグ（End tag, ここでは<code>&lt;/tr&gt;</code>）を表します。
    </li>
    <li>「<code>foreach (member in member_list) { ... }</code>」は繰り返しを表します。
    </li>
    </ul>
</li>
</ul>
<p>プレゼンテーションロジック(example1.plogic)：
</p>
<a name="example1.plogic"></a>
<pre class="program">#item {            // id="item" がついたエレメント
  value: member;      // 内容を変数memberの値で置き換える
  remove: "id";       // id属性を取り除く
}

#list {            // id="list" がついたエレメント
  remove: "id";       // id属性を取り除く
  plogic: {           // プレゼンテーションロジックを定義する
    foreach (member in member_list) {
      @stag;          // タグ(start tag)
      @cont;          // 内容(content)
      @etag;          // 終了タグ(end tag)
    }
  }
}
</pre>
<p>Kwartzはこの2つから各言語(eRuby, PHP, JSTL1.1&amp;1.0)用の出力用スクリプトを自動生成します。
これをコンパイルといいます。
コンパイルするにはコマンドラインで次のようにします。
</p>
<pre class="terminal">### for eRuby
$ kwartz -l eruby  -p example1.plogic example1.html &gt; example1.rhtml

### for PHP
$ kwartz -l php    -p example1.plogic example1.html &gt; example1.php

### for JSTL 1.1
$ kwartz -l jstl11 -p example1.plogic example1.html &gt; example1.jsp

### for JSTL 1.0
$ kwartz -l jstl10 -p example1.plogic example1.html &gt; example1.jsp

### for Velocity
$ kwartz -l velocity -p example1.plogic example1.html &gt; example1.vm
</pre>
<p>以下は自動生成された出力用スクリプトです。
</p>
<p>出力用スクリプト for eRuby (example1.rhtml):
</p>
<pre class="program">&lt;table&gt;
&lt;% for member in member_list do %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= member %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;
&lt;/table&gt;
</pre>
<p>出力用スクリプト for PHP (example1.php):
</p>
<pre class="program">&lt;table&gt;
&lt;?php foreach ($member_list as $member) { ?&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;?php echo $member; ?&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;?php } ?&gt;
&lt;/table&gt;
</pre>
<p>出力用スクリプト for JSTL 1.1<sup>(<a href="#fnref:3" name="fnlink:3">*3</a>)</sup>(example1.jsp):
</p>
<pre class="program">&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;table&gt;
&lt;c:forEach var="member" items="${member_list}"&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;c:out value="${member}" escapeXml="false"/&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/c:forEach&gt;
&lt;/table&gt;
</pre>
<p>出力用スクリプト for JSTL 1.0(example1.jsp):
</p>
<pre class="program">&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;table&gt;
&lt;c:forEach var="member" items="${member_list}"&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;c:out value="${member}" escapeXml="false"/&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/c:forEach&gt;
&lt;/table&gt;
</pre>
<p>出力用スクリプト for Velocity(example1.vm):
</p>
<pre class="program">&lt;table&gt;
#foreach($member in $member_list)
  &lt;tr&gt;
    &lt;td&gt;$!{member}&lt;/td&gt;
  &lt;/tr&gt;
#end
&lt;/table&gt;
</pre>
<p>またコンパイル時にコマンドオプション <code>-e</code> をつけると、サニタイズされた出力用スクリプトが生成されます。
サニタイズには、eRubyでは<code>CGI.escapeHTML()</code>が、PHPでは<code>htmlspecialchars()</code>が、
JSTLでは<code>escapeXml="false"</code>なしの<code>&lt;c:out/&gt;</code>が、VelocityではEscapeToolの<code>$esc.html()</code>が使用されます。
</p>
<p>これらの出力用スクリプトをメインプログラムから呼び出すと、Webページが出力されます。
呼び出し方は、各プログラミング言語によって異なります。
</p>
<p>メインプログラム(Ruby)：
</p>
<pre class="program">## データを用意する
member_list = [ 'Oboro', 'Ominae', 'Jaquemonde' ]

## ERBを使って出力する
require 'erb'
require 'cgi'        # for sanitizing
str = File.open('example1.rhtml') { |f| f.read() }
str.untaint
trim_mode = 1
erb = ERB.new(str, $SAFE, trim_mode)
print erb.result(binding())

## またはERubyを使う方法
require 'eruby'
require 'cgi'        # for sanitizing
ERuby::import('example1.rhtml')
</pre>
<p>メインプログラム(PHP)：
</p>
<pre class="program">&lt;?php
   // データを用意する
   $member_list = array('Oboro', 'Ominae', 'Jaquemonde');
   
   // 出力する
   include('example1.php');
 ?&gt;
</pre>
<p>メインプログラム(JSTL)：
</p>
<pre class="program">public void doGet(HttpServletRequest request,
                  HttpServletResponse response)
                  throws ServletException, IOException {
   ...
   // データを用意する
   java.util.List member_list = new java.util.ArrayList();
   member_list.add("Oboro");
   member_list.add("Ominae");
   member_list.add("Jaquemonde");

   // 出力
   RequestDispatcher dispatcher = 
       request.getRequestDispatcher("example1.jsp");
   dispatcher.include(request, response);
   // または dispatcher.forward(request, response);
}
</pre>
<p>メインプログラム(Velocity)：
</p>
<a name="Main1.java"></a>
<pre class="program">import org.apache.velocity.app.Velocity;
import org.apache.velocity.VelocityContext;
import org.apache.velocity.Template;
import org.apache.velocity.exception.ResourceNotFoundException;
import org.apache.velocity.exception.ParseErrorException;
import org.apache.velocity.exception.MethodInvocationException;
import java.io.OutputStreamWriter;
import java.io.IOException;

public class Main1 {
  public static void main(String[] args) {
    try {
    // 初期化
    Velocity.init();
 
    // データを用意する
    java.util.List member_list = new java.util.ArrayList();
    member_list.add("Oboro");
    member_list.add("Ominae");
    member_list.add("Jaquemonde");
 
    // Contextを作成しデータをセットする
    VelocityContext context = new VelocityContext();
    context.put("member_list", member_list);
 
    // テンプレートを読み込み、Contextとマージする。
    Template template = Velocity.getTemplate("Test.vm", "UTF8");
    OutputStreamWriter writer = new OutputStreamWriter(System.out);
    template.merge(context, writer);

    // 出力する
    writer.flush();
  }
  catch (ResourceNotFoundException ex) {
    // テンプレートが見つからなかった
  }
  catch (ParseErrorException ex) {
    // テンプレート解析時に構文エラーがあった
  }
  catch (MethodInvocationException ex) {
     // メソッド呼び出しができなかった
  }
  catch (IOException ex) {
    // 入出力に問題があった
  }
  catch (Exception ex) {
    // その他のエラー
  }
}
</pre>
<p>出力用プログラムを呼び出して実行すると、例えば次のようなWebページが生成されます。
</p>
<pre class="output">&lt;table&gt;
  &lt;tr&gt;
    &lt;td&gt;Oboro&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;Ominae&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;Jaquemonde&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
</pre>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:3" href="#fnlink:3">*3</a>)</dt>
  <dd>コマンドラインオプションとして「--charset=<i>CHARSET</i>」をつけると、JSTL用出力スクリプトでは「<code>&lt;%@ page contentType="text/html; charset=<i>CHARSET</i>" %&gt;</code>」をつけてくれます。</dd>
 </dl>
</div>
<br>


<a name="example2"></a>
<h3 class="section2">複雑な例</h3>
<p>もう少し複雑な例として、色つきのテーブルを示します。
</p>
<p>プレゼンテーションデータは次のようになります。
マーキングは「<code>id="<i>name</i>"</code>」ではなく「<code>id="mark:<i>name</i>"</code>」としています。
こうするとid属性は自動的に削除されますので、プレゼンテーションロジックファイルでいちいち「<code>remove: "id"</code>」と書く必要がなくなります。
</p>
<p>プレゼンテーションデータ(example2.html)：
</p>
<a name="example2.html"></a>
<pre class="program">&lt;table&gt;
 &lt;tr bgcolor="#CCCCFF" <b>id="mark:list"</b>&gt;
  &lt;td <b>id="mark:name"</b>&gt;foo&lt;/td&gt;
  &lt;td&gt;
   &lt;a href="mailto:foo@mail.com" <b>id="mark:email"</b>&gt;foo@mail.com&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>次はプレゼンテーションロジックです。
プレゼンテーションロジックでは、繰り返しを行いながら、奇数行か偶数行かの判定を行っています。
</p>
<p>プレゼンテーションロジック(example2.plogic)：
</p>
<a name="example2.plogic"></a>
<pre class="program">// id="mark:list" がついたエレメント：
// bgcolor属性の値として変数colorを出力する。
// また繰り返しを行い、奇数行と偶数行で変数colorの値を変える。
#list {
  attrs:  "bgcolor" color;
  plogic: {
    i = 0;
    foreach (member in member_list) {
      i += 1;
      color = i % 2 == 0 ? '#FFCCCC' : '#CCCCFF';
      @stag;    // 開始タグ(start tag)
      @cont;    // 内容    (content)
      @etag;    // 終了タグ(end tag)
    }
  }
}

// id="mark:name" がついたエレメント：
// 内容として member['name'] の値を出力する。
#name {
  value: member['name'];
}

// id="mark:email" がついたエレメント：
// 内容として member['email'] の値を出力する。
// またhref属性は "mailto:" .+ member['email'] の値を出力する。
// （「.+」は文字列の連結を行う演算子）
#email {
  value: member['email'];
  attrs: "href" ("mailto:" .+ member['email']);
}
</pre>
<p>見ておわかりのように、プレゼンテーションロジックにはHTMLタグが一切入らず、またプレゼンテーションデータにはロジックが一切入っていません。
つまり、プレゼンテーションデータとプレゼンテーションロジックの分離が実現できていることになります。
</p>
<p>なおインクリメント演算子（++）は使えませんので、<code>ctr++</code> のように書くことはできません。
</p>
<p>コンパイル：
</p>
<pre class="terminal">### for eRuby
$ kwartz -l eruby  -p example2.plogic example2.html &gt; example2.rhtml

### for PHP
$ kwartz -l php    -p example2.plogic example2.html &gt; example2.php

### for JSTL 1.1
$ kwartz -l jstl11 -p example2.plogic example2.html &gt; example2.jsp

### for JSTL 1.0
$ kwartz -l jstl10 -p example2.plogic example2.html &gt; example2.jsp

### for Velocity
$ kwartz -l velocity -p example2.plogic example2.html &gt; example2.vm
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;table&gt;
&lt;% i = 0 %&gt;
&lt;% for member in member_list do %&gt;
&lt;%   i += 1 %&gt;
&lt;%   color = i % 2 == 0 ? "#FFCCCC" : "#CCCCFF" %&gt;
 &lt;tr bgcolor="&lt;%= color %&gt;"&gt;
  &lt;td&gt;&lt;%= member["name"] %&gt;&lt;/td&gt;
  &lt;td&gt;
   &lt;a href="mailto:&lt;%= member["email"] %&gt;"&gt;&lt;%= member["email"] %&gt;&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
&lt;% end %&gt;
&lt;/table&gt;

### for PHP
&lt;table&gt;
&lt;?php $i = 0; ?&gt;
&lt;?php foreach ($member_list as $member) { ?&gt;
&lt;?php   $i += 1; ?&gt;
&lt;?php   $color = $i % 2 == 0 ? "#FFCCCC" : "#CCCCFF"; ?&gt;
 &lt;tr bgcolor="&lt;?php echo $color; ?&gt;"&gt;
  &lt;td&gt;&lt;?php echo $member["name"]; ?&gt;&lt;/td&gt;
  &lt;td&gt;
   &lt;a href="mailto:&lt;?php echo $member["email"]; ?&gt;"&gt;&lt;?php echo $member["email"]; ?&gt;&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
&lt;?php } ?&gt;
&lt;/table&gt;

### for JSTL
&lt;table&gt;
&lt;c:set var="i" value="0"/&gt;
&lt;c:forEach var="member" items="${member_list}"&gt;
  &lt;c:set var="i" value="${i + 1}"/&gt;
  &lt;c:set var="color" value="${i % 2 eq 0 ? '#FFCCCC' : '#CCCCFF'}"/&gt;
 &lt;tr bgcolor="&lt;c:out value="${color}" escapeXml="false"/&gt;"&gt;
  &lt;td&gt;&lt;c:out value="${member['name']}" escapeXml="false"/&gt;&lt;/td&gt;
  &lt;td&gt;
   &lt;a href="mailto:&lt;c:out value="${member['email']}" escapeXml="false"/&gt;"&gt;&lt;c:out value="${member['email']}" escapeXml="false"/&gt;&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
&lt;/c:forEach&gt;
&lt;/table&gt;

### for Velocity
&lt;table&gt;
#set($i = 0)
#foreach($member in $member_list)
  #set($i = $i + 1)
  #if($i % 2 == 0)
    #set($color = "#FFCCCC")
  #else
    #set($color = "#CCCCFF")
  #end
 &lt;tr bgcolor="$!{color}"&gt;
  &lt;td&gt;$!{member["name"]}&lt;/td&gt;
  &lt;td&gt;
   &lt;a href="mailto:$!{member["email"]}"&gt;$!{member["email"]}&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
#end
&lt;/table&gt;
</pre>
<br>


<a name="pattern"></a>
<h3 class="section2">プレゼンテーションロジックの応用例</h3>
<p>Kwartzでは、複雑なプレゼンテーションロジックが素直に記述できます。
ここではその例を示します。
なお『<a href="p-pattern.html">プレゼンテーションパターンカタログ</a>』もご覧ください。
</p>
<ul type="disc">
<li>エレメント全体を繰り返すことができます。
<pre class="program">#list {
  plogic: {
    foreach (member in member_list) {
      @stag;
      @cont;
      @etag;
    }
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>内容だけを繰り返すことができます。&lt;dl&gt;&lt;/dl&gt;で使うのに向いています。
<pre class="program">#list {
  plogic: {
    @stag;
    foreach (member in member_list) {
      @cont;
    }
    @etag;
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>内容のかわりに、変数や式などの値を出力することができます。
<pre class="program">#list {
  plogic: {
    @stag;
    print("Hello!");
    @etag;
  }
}
</pre>
   これは次のように書くこともできます。
<pre class="program">#list {
  value: "Hello!";
}
</pre>
</li>
</ul>
<ul type="disc">
<li>エレメントのかわりに、変数や式などの値を出力することができます。
<pre class="program">#list {
  plogic: {
    print("&lt;b&gt;Hello!&lt;/b&gt;");
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>内容だけを残し、開始タグと終了タグを消すことができます。
<pre class="program">#list {
  plogic: {
    @cont;
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>エレメント全体を消すことができます。これは、ダミーデータを消すときに便利です。
<pre class="program">#list {
  plogic: {
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>エレメント全体を、別のエレメントで置き換えることができます。
<pre class="program">#list {
  plogic: {
    @element(foo);  // 「foo」とマーキングされたエレメントを展開する
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>エレメントの内容を、別のエレメントで置き換えることができます。
<pre class="program">#list {
  plogic: {
    @stag;
    @element(foo);  // 「foo」とマーキングされたエレメントを展開する
    @etag;
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>複雑なプレゼンテーションロジックを含めることができます。
<pre class="program">#list {
  plogic: {
  i = 0;
  foreach (member in member_list) {
    i += 1;		// 注意：i++ や ++i は使えません
    if (i % 2 == 0) {
      color = 'red';
    } else {
      color = 'blue';
    }
    @stag;
    @cont;
    @etag;
  }
}
</pre>
</li>
</ul>
<p>ここで重要なのは、<b>プレゼンテーションロジックにはタグ名や属性名が一切出てきていない</b>という点です。
プレゼンテーションデータのほうでどんなにタグを変更したとしても、プレゼンテーションロジックはまったく変更する必要はありません。
</p>
<p>つまり、プレゼンテーションデータとプレゼンテーションロジックとが完全に分離されているわけです。
</p>
<br>


<br>


<a name="directives"></a>
<h2 class="section1">ディレクティブ</h2>
<p>Kwartzでは、プレゼンテーションデータの中にプレゼンテーションロジックを埋め込むこともできます。
つまり、両者を分離することも、一体化することもできるわけです。
</p>
<p>プレゼンテーションロジックをプレゼンテーションデータの中に埋め込むには、ディレクティブを用います。
ディレクティブとは、プレゼンテーションデータの中にプレゼンテーションロジックを埋め込むための命令です。
Kwartzでは、id属性とkw:d属性を用いてディレクティブを記述します。
</p>
<p>次はディレクティブを使った例です：
</p>
<ul type="disc">
<li>「<code>id="foreach:<i>var</i>=<i>list</i>"</code>」は、繰り返しを表します。
</li>
<li>「<code>id="value:<i>expression</i>"</code>」は、内容のかわりに式の値を出力することを表します。
</li>
<li>「<code>id="dummy:<i>str</i>"</code>」は、そのエレメントがダミーであることを表します（つまり出力されません）。
    ここで<code><i>str</i></code>はid属性の値が同じにならないようにするためのものであり、特に意味はありません。
</li>
<li>「<code>@{<i>expression</i>}@</code>」<sup>(<a href="#fnref:4" name="fnlink:4">*4</a>)</sup>は、式の値を出力するためのディレクティブです。
</li>
</ul>
<p>プレゼンテーションデータ(example3.html)：
</p>
<a name="example3.html"></a>
<pre class="program">&lt;table&gt;
  &lt;tr <b>id="foreach:member=member_list"</b>&gt;
    &lt;td <b>id="value:member['name']"</b>&gt;foo&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:<b>@{member['email']}@</b>"&gt;
         <b>@{member['email']}@</b>&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr <b>id="dummy:d1"</b>&gt;
    &lt;td&gt;bar&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:bar@mail.org"&gt;bar@mail.org&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr <b>id="dummy:d2"</b>&gt;
    &lt;td&gt;baz&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:baz@mail.net"&gt;baz@mail.net&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>コンパイル：
</p>
<pre class="terminal">### for eRuby
$ kwartz -l eruby   example3.html &gt; example3.rhtml

### for PHP
$ kwartz -l php     example3.html &gt; example3.php

### for JSTL1.1
$ kwartz -l jstl11  example3.html &gt; example3.jsp
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;table&gt;
&lt;% for member in member_list do %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= member["name"] %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:&lt;%= member["email"] %&gt;"&gt;
         &lt;%= member["email"] %&gt;&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;
&lt;/table&gt;

### for PHP
&lt;table&gt;
&lt;?php foreach ($member_list as $member) { ?&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;?php echo $member["name"]; ?&gt;&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:&lt;?php echo $member["email"]; ?&gt;"&gt;
         &lt;?php echo $member["email"]; ?&gt;&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;?php } ?&gt;
&lt;/table&gt;

### for JSTL
&lt;table&gt;
&lt;c:forEach var="member" items="${member_list}"&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;c:out value="${member['name']}" escapeXml="false"/&gt;&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:&lt;c:out value="${member['email']}" escapeXml="false"/&gt;"&gt;
         &lt;c:out value="${member['email']}" escapeXml="false"/&gt;&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/c:forEach&gt;
&lt;/table&gt;

### for Velocity
&lt;table&gt;
#foreach($member in $member_list)
  &lt;tr&gt;
    &lt;td&gt;$!{member["name"]}&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:$!{member["email"]}"&gt;
         $!{member["email"]}&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
#end
&lt;/table&gt;
</pre>
<p>このほか、条件分岐を行うディレクティブなども用意されています。
詳細はリファレンスマニュアルをご覧ください。
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:4" href="#fnlink:4">*4</a>)</dt>
  <dd>このパターンは設定ファイルの定数EMBED_PATTERNで変更できます。</dd>
 </dl>
</div>
<br>


<a name="sanitize"></a>
<h2 class="section1">サニタイズ</h2>
<p>Kwartzでは、自動でサニタイズを行うことができます。
またある部分だけをサニタイズする/しないを選択することもできます。
</p>
<a name="sanitize1"></a>
<h3 class="section2">自動サニタイズ</h3>
<p>コマンドラインオプション <code>-e</code> をつけると、出力スクリプトをサニタイズします。
サニタイズでは、eRubyでは<code>CGI.escapeHTML()</code>が、ERBでは<code>h()</code>が、PHPでは<code>htmlspecialchars()</code>が、JSTLでは<code>escapeXml="false"</code>なしの<code>&lt;c:out&gt;</code>が、Velocityでは<code>$!esc.html()</code>がそれぞれ使用されます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="sanitize1.html"></a>
<pre class="program">&lt;tr bgcolor="@{color}@"&gt;
  &lt;td id="value:str"&gt;foo&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>コンパイル：
</p>
<pre class="terminal">### for eRuby
$ kwartz -e -l eruby  sanitize1.html &gt; sanitize1.rhtml
	
### for ERB
$ kwartz -e -l erb    sanitize1.html &gt; sanitize1.rhtml
	
### for PHP
$ kwartz -e -l php    sanitize1.html &gt; sanitize1.php
	
### for JSTL
$ kwartz -e -l jstl   sanitize1.html &gt; sanitize1.jsp

### for Velocity
$ kwartz -e -l velocity sanitize1.html &gt; sanitize1.vm
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;tr bgcolor="&lt;%= CGI::escapeHTML((color).to_s) %&gt;"&gt;
  &lt;td&gt;&lt;%= CGI::escapeHTML((str).to_s) %&gt;&lt;/td&gt;
&lt;/tr&gt;

### for ERB
&lt;tr bgcolor="&lt;%=h(color)%&gt;"&gt;
  &lt;td&gt;&lt;%=h(str)%&gt;&lt;/td&gt;
&lt;/tr&gt;

### for PHP
&lt;tr bgcolor="&lt;?php echo htmlspecialchars($color); ?&gt;"&gt;
  &lt;td&gt;&lt;?php echo htmlspecialchars($str); ?&gt;&lt;/td&gt;
&lt;/tr&gt;

### for JSTL
&lt;tr bgcolor="&lt;c:out value="${color}"/&gt;"&gt;
  &lt;td&gt;&lt;c:out value="${str}"/&gt;&lt;/td&gt;
&lt;/tr&gt;

### for Velocity
&lt;tr bgcolor="$!esc.html($color)"&gt;
  &lt;td&gt;$!esc.html($str)&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>式が文字列や数値のような定数の場合は、サニタイズされません。
また「<code>flag ? 'checked' : ''</code>」のような条件演算子では、<code>flag</code>の値にかかわらず文字列定数が出力されますので、これもサニタイズされません。
</p>
<br>


<a name="sanitize2"></a>
<h3 class="section2">部分サニタイズ</h3>
<p>関数<code>E(<i>expr</i>)</code>は、コマンドラインオプションに関わらず式<code><i>expr</i></code>をサニタイズします。
また関数<code>X(<i>expr</i>)</code>は、コマンドラインオプションに関わらず式<code><i>expr</i></code>をサニタイズしません
<sup>(<a href="#fnref:5" name="fnlink:5">*5</a>)</sup>。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="sanitize-partial1.pdata"></a>
<pre class="program">&lt;table&gt;
 &lt;tr bgcolor="<b>@{X(color)}@</b>"&gt;
   &lt;td <b>id="value:E(str)"</b>&gt;foo&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>コンパイル：
</p>
<pre class="terminal">### for eRuby
$ kwartz -e -l eruby  sanitize1.html &gt; sanitize1.rhtml
	
### for ERB
$ kwartz -e -l erb    sanitize1.html &gt; sanitize1.rhtml
	
### for PHP
$ kwartz -e -l php    sanitize1.html &gt; sanitize1.php
	
### for JSTL 1.1
$ kwartz -e -l jstl11 sanitize1.html &gt; sanitize1.jsp

### for Velocity
$ kwartz -e -l velocity sanitize1.html &gt; sanitize1.vm
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;table&gt;
 &lt;tr bgcolor="&lt;%= color %&gt;"&gt;
   &lt;td&gt;&lt;%= CGI::escapeHTML((str).to_s) %&gt;&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;

### for ERB
&lt;table&gt;
 &lt;tr bgcolor="&lt;%= color %&gt;"&gt;
   &lt;td&gt;&lt;%=h(str)%&gt;&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;

### for PHP
&lt;table&gt;
 &lt;tr bgcolor="&lt;?php echo $color; ?&gt;"&gt;
   &lt;td&gt;&lt;?php echo htmlspecialchars($str); ?&gt;&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;

### for JSTL
&lt;table&gt;
 &lt;tr bgcolor="&lt;c:out value="${color}" escapeXml="false"/&gt;"&gt;
   &lt;td&gt;&lt;c:out value="${str}"/&gt;&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;

### for Velocity
&lt;table&gt;
 &lt;tr bgcolor="$!{color}"&gt;
   &lt;td&gt;$!esc.html($str)&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>またコマンドラインオプションに関係なく、「<code>id="Value:<i>expr</i>"</code>」や「<code>id="Attr:<i>name</i>=<i>expr</i>)"</code>」は式<code><i>expr</i></code>を必ずサニタイズします。
逆に、「<code>id="VALUE:<i>expr</i>"</code>」や「<code>id="ATTR:<i>name</i>=<i>expr</i>"</code>」は式<code><i>expr</i></code>を必ずサニタイズしません。
これらはそれぞれ、「<code>id="value:E(<i>expr</i>)"</code>」や「<code>id="attr:<i>name</i>=X(<i>expr</i>)"</code>」と同じです。
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:5" href="#fnlink:5">*5</a>)</dt>
  <dd>E()とX()は正確には擬似関数であり、PLにおけるprint文の引数に指定することはできますが、任意の式として使用できるわけではありません。例えば「<code>@{E(...)</code>}@」や「<code>id="value:E(...)"</code>」と書くことはできますが、「<code>id="set:str=E(...)"</code>」のようには書けません。</dd>
 </dl>
</div>
<br>


<a name="sanitize3"></a>
<h3 class="section2">サニタイズの設定</h3>
<p>kwartz/config.rbはKwartz-rubyの動作を設定しているファイルです。
デフォルトでサニタイズを行うように設定するには、この中で定数<code>ESCAPE</code>の値をtrueに変更します。
</p>
<br>


<br>


<a name="topics"></a>
<h2 class="section1">その他の話題</h2>
<a name="restriction"></a>
<h3 class="section2">制限事項</h3>
<p>Kwartzでは、HTMLパーサやXMLパーサを用いず、正規表現によるパターンマッチでHTMLファイルを解析しています。
そのため、HTMLではないテキストファイルでも利用できるという利点がありますが、次のような制限事項もあります。
</p>
<ul type="disc">
<li>id属性がついたタグは、終了タグを省略できません。
<pre class="program">&lt;!-- &lt;/li&gt; が指定されていないので解析できない --&gt;
&lt;ul&gt;
 &lt;li id="foo"&gt;foo
&lt;/ul&gt;
</pre>
   また内容を持たない場合は、<code>&lt;foo id="..."/&gt;</code>のような空タグとしてください。
</li>
</ul>
<ul type="disc">
<li>ただし、<code>&lt;input&gt;</code>と<code>&lt;br&gt;</code>と<code>&lt;meta&gt;</code>と<code>&lt;img&gt;</code>と<code>&lt;hr&gt;</code>は、終了タグを省略できます。
   また空タグにする必要もありません。
<pre class="program">&lt;!-- &lt;/input&gt; が省略されているが、正しく解析される --&gt;
&lt;input type="text" name="user" id="user"&gt;
</pre>
   なおこれらのタグ名はkwartz/config.rbの中で定数<code>NOEND</code>に設定されています。
   また大文字と小文字は区別されます。
</li>
</ul>
<ul type="disc">
<li>属性値は必ず「<code>"</code>」で囲ってください。また「'」で囲っても認識されません。
<pre class="program">&lt;!-- 属性値が「"」で囲まれていないので、解析できない --&gt;
&lt;h1 id="value:title" class=title&gt;title&lt;/h1&gt;
</pre>
</li>
</ul>
<br>


<a name="analyze"></a>
<h3 class="section2">グローバル変数とローカル変数</h3>
<p>Kwartzには、プレゼンテーションデータ/ロジックファイルを分析し、変数を調査する機能があります。
</p>
<p>Kwartzでは、メインプログラムで設定されて出力用スクリプトに渡される変数を「テンプレートグローバル変数」、
テンプレートの中でだけ使用される変数を「テンプレートローカル変数」と呼んでいます。
Kwartzは、変数がグローバルかローカルかを調べて報告する機能があります。
</p>
<p>次の例をご覧ください。
</p>
<p>プレゼンテーションデータ(analyze.html)：
</p>
<a name="analyze.html"></a>
<pre class="program">&lt;span kw:d="value:<b>title</b>"&gt;Analyzer Example&lt;/span&gt;
&lt;dl id="mark:items"&gt;
  &lt;dt kw:d="value:<b>ctr</b>"&gt;&lt;/dt&gt;
  &lt;dd kw:d="value:<b>item</b>"&gt;Foo&lt;/dd&gt;
&lt;/dl&gt;
</pre>
<p>プレゼンテーションロジック(analyze.plogic)：
</p>
<a name="analyze.plogic"></a>
<pre class="program">#items {
  plogic: {
    @stag;
    <b>ctr</b> = 0;
    foreach (<b>item</b> in <b>list</b>) {
      <b>ctr</b> += 1;
      @cont;
    }
    @etag;
  }
}
</pre>
<p>この例では4つの変数があります。
このうち、<code>item</code>と<code>ctr</code>はテンプレート中でだけ使われるのでテンプレートローカル変数、
<code>title</code>と<code>list</code>はメインプログラムで設定されて出力用スクリプトに渡されるのでテンプレートグローバル変数です。
</p>
<p>kwartzをコマンドランオプション <code>-a analyze</code> をつけて起動すると、グローバル変数とローカル変数を報告してくれます。
</p>
<p>実行例：
</p>
<pre class="terminal">$ kwartz -a analyze -p analyze.plogic analyze.html
<b>Global: title list</b>
<b>Local:  ctr item</b>
</pre>
<br>


<a name="rename"></a>
<h3 class="section2">テンプレートグローバル/ローカル変数の名前を変更する</h3>
<p>Kwartzでは、テンプレートグローバル変数とテンプレートローカル変数の、両方または一方の名前にプレフィックスをつけることができます。
プレフィックスをつけるには、コマンドラインオプション「<code>--globalvar-prefix=<i>prefix</i></code>」と「<code>--localvar-prefix=<i>prefix</i></code>」を使用します。
</p>
<p>例えばRubyやPHPでは、メインプログラムで使用している変数名と、テンプレートのローカル変数名とが一致した場合、
テンプレート側の変数を変更することでメインプログラムの動作に影響を与えてしまうという問題があります。
これを避けるには、テンプレートローカル変数名に例えば「_」というプレフィックスをつけます。
</p>
<p>前の節で使用したanalyze.htmlとanalyze.plogicを使ってみます。
</p>
<p>実行例：
</p>
<pre class="terminal">$ kwartz -l eruby  -p analyze.plogic <b>--localvar-prefix='_'</b> analyze.html
$ kwartz -l php    -p analyze.plogic <b>--localvar-prefix='_'</b> analyze.html
$ kwartz -l jstl11 -p analyze.plogic <b>--localvar-prefix='_'</b> analyze.html
$ kwartz -l velocity -p analyze.plogic <b>--localvar-prefix='_'</b> analyze.html
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;%= title %&gt;
&lt;dl&gt;
&lt;% _ctr = 0 %&gt;
&lt;% for _item in list do %&gt;
&lt;%   _ctr += 1 %&gt;
  &lt;dt&gt;&lt;%= _ctr %&gt;&lt;/dt&gt;
  &lt;dd&gt;&lt;%= _item %&gt;&lt;/dd&gt;
&lt;% end %&gt;
&lt;/dl&gt;

### for PHP
&lt;?php echo $title; ?&gt;
&lt;dl&gt;
&lt;?php $_ctr = 0; ?&gt;
&lt;?php foreach ($list as $_item) { ?&gt;
&lt;?php   $_ctr += 1; ?&gt;
  &lt;dt&gt;&lt;?php echo $_ctr; ?&gt;&lt;/dt&gt;
  &lt;dd&gt;&lt;?php echo $_item; ?&gt;&lt;/dd&gt;
&lt;?php } ?&gt;
&lt;/dl&gt;

### for JSTL
&lt;c:out value="${title}" escapeXml="false"/&gt;
&lt;dl&gt;
&lt;c:set var="_ctr" value="0"/&gt;
&lt;c:forEach var="_item" items="${list}"&gt;
  &lt;c:set var="_ctr" value="${_ctr + 1}"/&gt;
  &lt;dt&gt;&lt;c:out value="${_ctr}" escapeXml="false"/&gt;&lt;/dt&gt;
  &lt;dd&gt;&lt;c:out value="${_item}" escapeXml="false"/&gt;&lt;/dd&gt;
&lt;/c:forEach&gt;
&lt;/dl&gt;

### for Velocity
$!{title}
&lt;dl&gt;
#set($_ctr = 0)
#foreach($_item in $list)
  #set($_ctr = $_ctr + 1)
  &lt;dt&gt;$!{_ctr}&lt;/dt&gt;
  &lt;dd&gt;$!{_item}&lt;/dd&gt;
#end
&lt;/dl&gt;
</pre>
<p>なお設定ファイルの定数「GLOBALVAR_PREFIX」と「LOCALVAR_PREFIX」で、
デフォルトのプレフィックスを指定できます。
</p>
<br>


<a name="span"></a>
<h3 class="section2">spanタグの削除</h3>
<p>Kwartzでは、ディレクティブしか含まないようなspanタグは、ダミータグとみなされて自動的に削除されます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="topics-span1.pdata"></a>
<pre class="program">&lt;h1&gt;&lt;span id="mark:title"&gt;title&lt;/span&gt;&lt;/h1&gt;

Hello &lt;span id="value:user"&gt;World&lt;/span&gt;!
</pre>
<p>プレゼンテーションロジック：
</p>
<a name="topics-span1.plogic"></a>
<pre class="program">#title {
  value: title;
}
</pre>
<p>出力用スクリプト(for eRuby)：
</p>
<pre class="program">&lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;

Hello &lt;%= user %&gt;!
</pre>
<p>spanタグが他の属性を含んでいた場合は、削除されません。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="topics-span2.pdata"></a>
<pre class="program">&lt;h1&gt;&lt;span id="mark:title" class="title"&gt;title&lt;/span&gt;&lt;/h1&gt;

Hello &lt;span kw:d="value:user" style="color:black"&gt;World&lt;/span&gt;!
</pre>
<p>出力用スクリプト(for eRuby)：
</p>
<pre class="program">&lt;h1&gt;&lt;span class="title"&gt;&lt;%= title %&gt;&lt;/span&gt;&lt;/h1&gt;

Hello &lt;span style="color:black"&gt;&lt;%= user %&gt;&lt;/span&gt;!
</pre>
<br>


<a name="topics-append"></a>
<h3 class="section2">開始タグに式の値を追加する</h3>
<p>「<code>&lt;input type="..." checked&gt;</code>」のようにする場合は、次のようにします。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="topics-append1.pdata"></a>
<pre class="program">&lt;input type="checkbox" name="foo" value="Y" id="foo" /&gt;
</pre>
<p>プレゼンテーションロジック：
</p>
<a name="topics-append1.plogic"></a>
<pre class="program">#foo {
  append: flag ? ' checked' : '';
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;input type="checkbox" name="foo" value="Y" id="foo"&lt;%= flag ? " checked" : "" %&gt; /&gt;

### for PHP
&lt;input type="checkbox" name="foo" value="Y" id="foo"&lt;?php echo $flag ? " checked" : ""; ?&gt; /&gt;

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;input type="checkbox" name="foo" value="Y" id="foo"&lt;c:out value="${flag ? ' checked' : ''}" escapeXml="false"/&gt; /&gt;

### for JSTL 1.0
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;c:choose&gt;&lt;c:when test="${flag}"&gt;
&lt;input type="checkbox" name="foo" value="Y" id="foo" checked /&gt;
&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;input type="checkbox" name="foo" value="Y" id="foo" /&gt;
&lt;/c:otherwise&gt;&lt;/c:choose&gt;

### for Velocity
#if($flag)
&lt;input type="checkbox" name="foo" value="Y" id="foo" checked /&gt;
#else
&lt;input type="checkbox" name="foo" value="Y" id="foo" /&gt;
#end
</pre>
<p>ディレクティブ <code>id="append:<i>expr</i>"</code> でも同じことができます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="topics-append2.pdata"></a>
<pre class="program">&lt;input type="checkbox" name="foo" value="Y" id="append:flag?' checked':''" /&gt;
</pre>
<p>また<code>checked="checked"</code>や<code>selected="selected"</code>を簡単に出力するための関数を用意しています。
「<code>C(<i>expr</i>)</code>」「<code>S(<i>expr</i>)</code>」「<code>D(<i>expr</i>)</code>」は式<code><i>expr</i></code>が真だった場合に、
それぞれ「<code> checked="checked"</code>」「<code> selected="selected"</code>」「<code> disabled="disabled"</code>」を出力します。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="topics-append3.pdata"></a>
<pre class="program">&lt;input type="checkbox" name="foo" value="Y" id="foo" /&gt;
</pre>
<p>プレゼンテーションロジック：
</p>
<a name="topics-append3.plogic"></a>
<pre class="program">#foo {
  append: C(foo == 100);
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;input type="checkbox" name="foo" value="Y" id="foo"&lt;%= foo == 100 ? " checked=\"checked\"" : "" %&gt; /&gt;

### for PHP
&lt;input type="checkbox" name="foo" value="Y" id="foo"&lt;?php echo $foo == 100 ? " checked=\"checked\"" : ""; ?&gt; /&gt;

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;input type="checkbox" name="foo" value="Y" id="foo"&lt;c:out value="${foo eq 100 ? ' checked="checked"' : ''}" escapeXml="false"/&gt; /&gt;

### for JSTL 1.0
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;c:choose&gt;&lt;c:when test="${foo eq 100}"&gt;
&lt;input type="checkbox" name="foo" value="Y" id="foo" checked="checked" /&gt;
&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;input type="checkbox" name="foo" value="Y" id="foo" /&gt;
&lt;/c:otherwise&gt;&lt;/c:choose&gt;

### for Velocity
#if($foo == 100)
&lt;input type="checkbox" name="foo" value="Y" id="foo" checked="checked" /&gt;
#else
&lt;input type="checkbox" name="foo" value="Y" id="foo" /&gt;
#end
</pre>
<br>


<a name="rawcode"></a>
<h3 class="section2">プレゼンテーションロジックをターゲット言語で記述する</h3>
<p>Kwartzでは、ターゲット言語（RubyやPHPやJavaなど）でプレゼンテーションロジックを記述することができます。
</p>
<ul type="disc">
<li>「<code>&lt;%= <i>expression</i> %&gt;</code> 」または「<code>&lt;?= <i>expression</i> ?&gt;</code> 」は、
   ターゲット言語で式を記述します。
</li>
<li>「<code>&lt;% <i>statement</i> %&gt;</code>」または「<code>&lt;? <i>statement</i> ?&gt;</code>」は、
   ターゲット言語で文を記述します。「<code>%&gt;</code>」や「<code>?&gt;</code>」のあとに「;」はつけません。
</li>
</ul>
<p>プレゼンテーションロジック(eRuby)：
</p>
<a name="topics-rawcode.plogic"></a>
<pre class="program">#foo {
  value:  <b>&lt;%= str.empty? ? "null" : str %&gt;</b>;
  plogic: {
    @stag;
    <b>&lt;% ENV.each do |name, value| %&gt;</b>
      @cont;
    <b>&lt;% end %&gt;</b>
    @etag;
  }
}
</pre>
<p>プレゼンテーションロジック(PHP)：
</p>
<a name="topics-rawcode2.plogic"></a>
<pre class="program">#foo {
  value:  <b>&lt;?= $str === NULL ? "null" : str ?&gt;</b>;
  plogic: {
    @stag;
    <b>&lt;?php foreach ($_ENV as $name =&gt; $value) { ?&gt;</b>
      @cont;
    <b>&lt;?php } ?&gt;</b>
    @etag;
  }
}
</pre>
<p>Kwartzは、「<code>&lt;%= ... %&gt;</code>」や「<code>&lt;% ... %&gt;</code>」で囲まれた部分をそのまま出力するだけです。
中身を一切解析しませんので、文法に間違いがあっても検出されませんし、
テンプレートローカル変数/グローバル変数の解析もできません。
</p>
<p>なお「<code>X(&lt;%= <i>expression</i> %&gt;)</code>」とすれば、<i>expression</i>をサニタイズせずに出力できます。
</p>
<br>


<a name="rails"></a>
<h3 class="section2">Ruby on Railsで使用する</h3>
<p>Ruby on RailsでKwartzを使うには、コマンドオプションとして「<code>-l erb</code>」と「<code>--globalvar-prefix='@'</code>」をつけます。
Kwartz-rubyでは、これをまとめて行うコマンドオプション「<code>-Rails</code>」を特別に用意しています。
</p>
<p>またプレゼンテーションロジックファイルにおいてRuby on Rails特有の関数を使う場合は、
「<code>&lt;% <i>...</i> %&gt;</code>」や「<code>&lt;%= <i>...</i> %&gt;</code>」を使います（もちろん、プレゼンテーションデータファイルに直接埋め込んでもよいです）。
</p>
<p>プレゼンテーションデータ(list.html)：
</p>
<a name="list.html"></a>
<pre class="program">&lt;html&gt;
 &lt;body&gt;

  &lt;h1&gt;Online Cookbook - All Recipes&lt;/h1&gt;
  
  &lt;table border="1"&gt;
   &lt;tr&gt;
    &lt;th width="80%"&gt;Recipe&lt;/th&gt;
    &lt;th width="20%"&gt;Date&lt;/th&gt;
   &lt;/tr&gt;
   &lt;tr <b>id="mark:recipes"</b>&gt;
    &lt;td&gt;&lt;a href="..." <b>id="mark:recipe_title"</b>&gt;Hot Chips&lt;/a&gt;&lt;/td&gt;
    &lt;td <b>id="mark:recipe_date"</b>&gt;2004 November 11&lt;/td&gt;
   &lt;/tr&gt;
   &lt;tr <b>id="dummy:d1"</b>&gt;
    &lt;td&gt;&lt;a href="..."&gt;Ice Water&lt;/a&gt;&lt;/td&gt;
    &lt;td&gt;2004 November 11&lt;/td&gt;
   &lt;/tr&gt;
  &lt;/table&gt;

  &lt;p&gt;
   &lt;a href="..." <b>id="mark:recipe_new"</b>&gt;Create new recipe&lt;/a&gt;
  &lt;/p&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>プレゼンテーションロジック(list.plogic)：
</p>
<a name="list.plogic"></a>
<pre class="program">#recipes {
  plogic: {
    foreach (recipe in recipes) {
      @stag;   // start tag
      @cont;   // content
      @etag;   // end tag
    }
  }
}

#recipe_title {
  value: recipe.title;
  attrs: "href" &lt;%= url_for(:action =&gt; "show", :id =&gt; recipe.id) %&gt;;
}

// または次のようにしてもよい。
//  #recipe_title {
//    plogic: {
//      print(&lt;%= link_to recipe.title, :action =&gt; "show", :id =&gt; recipe.id %&gt;);
//    }
//  }

#recipe_date {
  value: recipe.date;
}

#recipe_new {
  attrs: "href" &lt;%= url_for(:action =&gt; "new") %&gt;;
}

// または次のようにしてもよい。
//  #recipe_new {
//    plogic: {
//      print(&lt;%= link_to "Create new recipe", :action =&gt; "new" %&gt;);
//    }
//  }
</pre>
<p>コンパイル：
</p>
<pre class="terminal">$ kwartz <b>-Rails</b> -p list.plogic list.html &gt; list.rhtml
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">&lt;html&gt;
 &lt;body&gt;

  &lt;h1&gt;Online Cookbook - All Recipes&lt;/h1&gt;
  
  &lt;table border="1"&gt;
   &lt;tr&gt;
    &lt;th width="80%"&gt;Recipe&lt;/th&gt;
    &lt;th width="20%"&gt;Date&lt;/th&gt;
   &lt;/tr&gt;
&lt;% for recipe in @recipes do %&gt;
   &lt;tr&gt;
    &lt;td&gt;&lt;a href="&lt;%= url_for(:action =&gt; "show", :id =&gt; recipe.id) %&gt;"&gt;&lt;%= recipe.title %&gt;&lt;/a&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= recipe.date %&gt;&lt;/td&gt;
   &lt;/tr&gt;
&lt;% end %&gt;
  &lt;/table&gt;

  &lt;p&gt;
   &lt;a href="&lt;%= url_for(:action =&gt; "new") %&gt;"&gt;Create new recipe&lt;/a&gt;
  &lt;/p&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>なお「<code>X(&lt;%= <i>expression</i> %&gt;)</code>」とすれば、<i>expression</i>をサニタイズせずに出力できます。
</p>
<br>


<a name="topic-defun"></a>
<h3 class="section2">テンプレートをRubyまたはPHPの関数にコンパイルする</h3>
<p>コマンドラインオプション「<code>-a defun</code>」を指定すると、テンプレートをRubyまたはPHPの関数に変換できます。
</p>
<p>プレゼンテーションデータ(hoge1.html)：
</p>
<a name="hoge1.html"></a>
<pre class="program">Hello @{user}@ !
&lt;ul id="mark:list"&gt;
  &lt;li id="value:item"&gt;xxx&lt;/li&gt;
&lt;/ul&gt;
</pre>
<p>プレゼンテーションロジック(hoge1.plogic)：
</p>
<a name="hoge1.plogic"></a>
<pre class="program">#list {
  plogic: {
    @stag;
    foreach (item in list) {
      @cont;
    }
    @stag;
  }
}
</pre>
<p>コンパイル：
</p>
<pre class="terminal">$ kwartz -l eruby <b>-a defun</b> -p hoge1.plogic hoge1.html &gt; hoge1.rb
$ kwartz -l php   <b>-a defun</b> -p hoge1.plogic hoge1.html &gt; hoge1.php
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
  def view_hoge1(__args)
    user = __args[:user]
    list = __args[:list]
    return _view_hoge1(user,list)
  end
  def _view_hoge1(user,list)
    _erbout = ''; _erbout &lt;&lt; "Hello "; _erbout &lt;&lt;(( user ).to_s); _erbout &lt;&lt; " !\n"
    _erbout &lt;&lt; "&lt;ul&gt;\n"
     for item in list do 
    _erbout &lt;&lt; "  &lt;li&gt;"; _erbout &lt;&lt;(( item ).to_s); _erbout &lt;&lt; "&lt;/li&gt;\n"
     end 
    _erbout &lt;&lt; "&lt;ul&gt;\n"
    _erbout
  end

### for PHP
&lt;?php
    function view_hoge1($__args) {
        $user = $__args['user']
        $list = $__args['list']
        return _view_hoge1(user,list)
    }
    function _view_hoge1(user,list) {
        ob_start();
?&gt;Hello &lt;?php echo $user; ?&gt; !
&lt;ul&gt;
&lt;?php foreach ($list as $item) { ?&gt;
  &lt;li&gt;&lt;?php echo $item; ?&gt;&lt;/li&gt;
&lt;?php } ?&gt;
&lt;ul&gt;
&lt;?php
        $__s = ob_get_contents();
        ob_end_clean();
        return $__s;
    }
?&gt;</pre>
<p>関数は2つ定義されます。どちらでもお好きなほうをお使いください。
</p>
<ul type="disc">
<li>引数をハッシュで与える関数<code>view_<i>filename</i>()</code>
</li>
<li>引数を明示的に指定する関数<code>_view_<i>filename</i>()</code>
</li>
</ul>
<p>コマンドラインオプション「<code>-C <i>name</i></code>」でクラス名またはモジュール名を、
「<code>-F <i>name</i></code>」で関数名またはメソッド名を、
「<code>-A <i>name</i></code>」で引数を指定できます。
また設定ファイルの「DEFUN_CLASS」でクラス名またはモジュール名を、
「DEFUN_FUNCTION」で関数名またはメソッド名を指定できます。
</p>
<br>


<br>



   </div>
  </blockquote>

 </body>
</html>
