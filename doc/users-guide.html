<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html">
  <title>Kwartz 3.0 Users' Guide</title>
  <meta name="author" content="Makoto Kuwata &lt;kwa(at)kuwata-lab.com&gt;">
  <meta name="generator" content="kwaser">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <link rel="stylesheet" href="docstyle.css" type="text/css">
 </head>
 <body>

  <blockquote>
   <div class="mainbody">

    <div align="left"><h1>Kwartz 3.0 Users' Guide</h1></div>
    <div align="left">
      Makoto Kuwata &lt;kwa(at)kuwata-lab.com&gt;<br>
      last update: $Date$<br>
    </div>

<a name="preface"></a>
<h2 class="section1">Preface</h2>
<p>This is the users' guide of Kwartz<sup>(<a href="#fnref:1" name="fnlink:1">*1</a>)</sup>,
a template system which realized the concept of 'Independence of Presentation Logic'.
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:1" href="#fnlink:1">*1</a>)</dt>
  <dd>Development of Kwartz had subsidized by Exploratory Software Project of <a href="http://www.ipa.go.jp/about/english/index.html">IPA (Information-Technology Promotion Agency Japan)</a>.</dd>
 </dl>
</div>
<a name="toc"></a>
<h3 class="section2">Table of Contents</h3>
<ul>
  <li><a href="#preface">Preface</a>
  <ul>
    <li><a href="#toc">Table of Contents</a>
    </li>
  </ul>
  </li>
  <li><a href="#intro">Introduction to Kwartz</a>
  <ul>
    <li><a href="#whatis">What's Kwartz?</a>
    </li>
    <li><a href="#features">Features Overview</a>
    </li>
    <li><a href="#example1">Simple Example</a>
    </li>
    <li><a href="#example2">Complex Example</a>
    </li>
    <li><a href="#pattern">Other Examples of Presentation Logic</a>
    </li>
  </ul>
  </li>
  <li><a href="#detail">Features Detail</a>
  <ul>
    <li><a href="#ruleset">RuleSet and Properties</a>
    </li>
    <li><a href="#directives">Directives</a>
    </li>
    <li><a href="#escape">Escape</a>
    </li>
    <li><a href="#langs">Multi-language</a>
    </li>
    <li><a href="#span">Span Tag Deletion</a>
    </li>
    <li><a href="#import-plogic">Import Presentation Logic File</a>
    </li>
    <li><a href="#import-elem">Import Elements in Other Files</a>
    </li>
    <li><a href="#extract">Extract Element</a>
    </li>
    <li><a href="#print-statement">Print Statement</a>
    </li>
    <li><a href="#begin">Add Code at Beginning/End of Document</a>
    </li>
  </ul>
  </li>
  <li><a href="#rails">Ruby on Rails Support</a>
  <ul>
    <li><a href="#helper_rails">Support of Ruby on Rails</a>
    </li>
    <li><a href="#start_link_tag"><code>link_to()</code> method in Ruby on Rails</a>
    </li>
    <li><a href="#rails-scaffold">Scaffold Kwartz Template</a>
    </li>
    <li><a href="#rails-helper-methods">Rails Helper Methods</a>
    </li>
  </ul>
  </li>
  <li><a href="#topics">Other Topics</a>
  <ul>
    <li><a href="#restriction1">Restrictions around presentation logic</a>
    </li>
    <li><a href="#restriction2">Restrictions around presentation data</a>
    </li>
    <li><a href="#makefile">Makefile and Rakefile</a>
    </li>
    <li><a href="#kwartz-lib">Use Kwartz as Library</a>
    </li>
  </ul>
  </li>
</ul>
<br>


<br>


<a name="intro"></a>
<h2 class="section1">Introduction to Kwartz</h2>
<a name="whatis"></a>
<h3 class="section2">What's Kwartz?</h3>
<p>Kwartz<sup>(<a href="#fnref:2" name="fnlink:2">*2</a>)</sup> is a template system
which realized the concept of <strong>'Independence of Presentation Logic'(IoPL)</strong>.
It means that Kwartz separates presentaion logics from both presentation data (typically HTML document) and business logics.
</p>
<p>You know CSS (Cascading Style Sheet). CSS separates design from HTML file.
In the same way, Kwartz separates presentation logics from HTML template.
If you are familiar with CSS, you'll be also familiar with Kwartz.
</p>
<p>The following figure show the relation of HTML, CSS, JavaScript, and Kwartz.
</p>
<ul type="disc">
<li>HTML represents document structure.
</li>
<li>CSS represents document design.
</li>
<li>JavaScript represents client-side logics.
</li>
<li>Kwartz represents server-side presentation logics.<br>
   (Notice that Kwartz represents only presentation logics and not business logics.)
</li>
</ul>
<div style="text-align: center">
<span>Figure1. Relation of HTML, CSS, JavaScript, and Kwartz.</span><br />
<img src="img/fig04.png" alt="relation of HTML, CSS, JavaScript, and Kwartz" />
</div>
<p>Kwartz-ruby is an implemenation of Kwartz in Ruby.
There is a plan to implement Kwartz in PHP or Java.
</p>
<p>In the following, the word 'Kwartz' means the specification of the template system
and the word 'Kwartz-ruby' means the implementation of it in Ruby language.
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:2" href="#fnlink:2">*2</a>)</dt>
  <dd>'Kwartz' is pronounced like 'Quartz'.</dd>
 </dl>
</div>
<br>


<a name="features"></a>
<h3 class="section2">Features Overview</h3>
<p>Kwartz has the following features:
</p>
<dl class="dl2">
<dt class="dt2">
Separates presentation logic from presentation data.</dt>
<dd class="dd2">
<p>	Using template systems such as Smarty, Velocity, XMLC, amrita, etc,
	you can separate HTML design from business logic as a template.
	With Kwartz, you can separate presentation logic from a template.
	In other words, Kwartz divides a template into 'presentation data' and 'presentation logic'.
	You need not mix presentation logic into HTML files nor main program.
</p>
</dd>
<dt class="dt2">
Very fast</dt>
<dd class="dd2">
<p>	Kwartz creates a script from a template (= presentation data and presentaion logic). 
	All you have to do in main program is to call the output script.
	Because Kwartz doesn't use DOM trees or the like, it is both fast and light-weight.
</p>
</dd>
<dt class="dt2">
Multi-languages support</dt>
<dd class="dd2">
<p>	Kwartz can create output scripts for Ruby(eRuby), PHP, JSP(JSTL 1.2 &amp; 1.1).
	Presentation logics are written in each language<sup>(<a href="#fnref:3" name="fnlink:3">*3</a>)</sup>.
	This approach gives you the power of the target language fully.
	For example, you can write Ruby on Rails helper method (such as <code>link_to</code>, <code>field_tag</code>, and so on) directly in your template file.
</p>
</dd>
<dt class="dt2">
Doesn't break HTML design at all</dt>
<dd class="dd2">
<p>	You must use directives like 
	<code>{foreach ...}{/foreach}</code> in <a href="http://smarty.php.net/">Smarty</a> or
	<code>#foreach(...)</code> in <a href="http://jakarta.apache.org/velocity/">Jakarta Velocity</a>.
	These directives break the HTML design of template.
	Kwartz doesn't break HTML design because Kwartz uses id or title attributes for marking in an HTML template.
</p>
</dd>
<dt class="dt2">
Able to handle any text file</dt>
<dd class="dd2">
<p>	Kwartz uses an original template parser; not using an HTML or XML parser,
	it is able to handle any type of text file (HTML, PostScript, CSV, and so on).
	This also means that Kwartz can handle non-well-formed XML files, as well as well-formed XML files.
	This is an advantage of Kwartz against <a href="http://xmlc.objectweb.org/">Enhydra XMLC</a> or
	<a href="http://amrita.sourceforge.jp/">amrita</a>, which handle only XML/HTML files.
</p>
</dd>
<dt class="dt2">
Auto-escape and Partial-escape</dt>
<dd class="dd2">
<p>	Kwartz can do sanitizing automatically.
	You don't need to write '<code>CGI.escapeHTML(var)</code>' or '<code>htmlspecialchars($var)</code>'.
	You are free to turn sanitizing on/off, as well specifying which parts of the template to sanitize.
</p>
</dd>
</dl>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:3" href="#fnlink:3">*3</a>)</dt>
  <dd>Previous version of Kwartz adopt original language and convert it to each target language(Ruby, PHP, JSTL, and so on). From Current version, it is required to write presentation logic in target language.</dd>
 </dl>
</div>
<br>


<a name="example1"></a>
<h3 class="section2">Simple Example</h3>
<p>In Kwartz, a template is defined as both presentation data and presentation logic.
They may be described in separate files.
</p>
<p>This is an example of a presentation data file.
</p>
<ul type="disc">
<li>'<strong><code>id="list1"</code></strong>' means "I'll operate this element in presentation logic" (called 'marking' in Kwartz).
</li>
<li>'<strong><code>id="mark:item1"</code></strong>' is also an marking.
   Difference between <code>id="mark:item1"</code> and <code>id="item1"</code> is that id attribute in the former format is removed automatically and the latter format is leaved.
</li>
</ul>
<p>Presentation data file(example1.html):
</p>
<a name="example1.html"></a>
<pre class="program">&lt;table&gt;
  &lt;tr <strong>id="list1"</strong>&gt;
    &lt;td <strong>id="mark:item1"</strong>&gt;foo&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>And the following is an example of presentation logic.
In presentation logic, you can operate on elements which are marked in presentation data.
</p>
<ul type="disc">
<li>'<strong><code>#list1 { ... }</code></strong>' represents an element marked with name 'list1' (= '&lt;tr&gt;...&lt;/tr&gt;')
    <ul type="circle">
    <li>'<strong><code>logic: { ... }</code></strong>' represents presentation logic of the element.
    </li>
    <li>'<strong><code>_stag</code></strong>' represents a start tag (= '&lt;tr&gt;').
    </li>
    <li>'<strong><code>_cont</code></strong>' represents content(= '&lt;td id="mark:item1"&gt;foo&lt;/td&gt;').
    </li>
    <li>'<strong><code>_etag</code></strong>' represents an end tag(= '&lt;/tr&gt;').
    </li>
    <li>'<strong><code>for <em>var</em> in <em>list</em> ...</code></strong>' is a Ruby code to loop.
       In this case, the element(= start-tag + content + end-tag) is looped.
    </li>
    </ul>
</li>
<li>'<strong><code>#item1 { ... }</code></strong>' represents an element marked with name 'item1' (= '&lt;td&gt;...&lt;/td&gt;').
    <ul type="circle">
    <li>'<strong><code>value: <em>expression</em>;</code></strong>' represents that the content of the element is replaced by value of <code><em>expression</em></code>, which is value of a variable <code>member</code> in this case.
    </li>
    </ul>
</li>
</ul>
<a name="example1.plogic"></a>
<div class="program_caption">
Presentation logic file(example1.plogic):</div>
<pre class="program">/* The element which is marked by 'id="list1"' */
<strong>#list1</strong> {
  logic: {
    for member in @members
      <strong>_stag</strong>           # start tag
      <strong>_cont</strong>           # content
      <strong>_etag</strong>           # end tag
    end
  }
}

/* The element which is marked by 'id="mark:item1"' */
<strong>#item1</strong> {
  /* replace the content with value of a variable 'member' */
  value: member;
}
</pre>
<p>(Don't forget the semicolon at the end of line especially for Ruby user!)
</p>
<p>Kwartz generates eRuby script from the above files. This action is called 'compiling'.
</p>
<div class="terminal_caption">
how to compile eRuby script</div>
<pre class="terminal">$ kwartz -p example1.plogic example1.html &gt; example1.rhtml
</pre>
<p>The following is the compiled eRuby script.
Notice that <code>id="mark:item1"</code> is removed automatically while <code>id="list1"</code> is leaved.
</p>
<a name="example1.expected"></a>
<div class="program_caption">
generated eRuby script</div>
<pre class="program">&lt;table&gt;
&lt;%     for member in @members %&gt;
  &lt;tr id="list1"&gt;
    &lt;td&gt;&lt;%= member %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;%     end %&gt;
&lt;/table&gt;
</pre>
<br>


<a name="example2"></a>
<h3 class="section2">Complex Example</h3>
<p>Next is bordered table example which is a little complex than previous.
</p>
<a name="example2.html"></a>
<div class="program_caption">
Presentation Data (example2.html):</div>
<pre class="program">&lt;table&gt;
 &lt;tr bgcolor="#CCCCFF" <strong>id="mark:list"</strong>&gt;
  &lt;td <strong>id="mark:name"</strong>&gt;foo&lt;/td&gt;
  &lt;td&gt;
   &lt;a href="mailto:foo@mail.com" <strong>id="mark:email"</strong>&gt;foo@mail.com&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>The following is the presentation logic file.
In the presentation logic, you should detect whether odd or even line in the iteration.
</p>
<p>Presentation Logic (example2.plogic):
</p>
<a name="example2.plogic"></a>
<pre class="program">/*
 * an element which is marked by 'id="mark:list"'
 *  - print value of a variable 'color' as bgcolor attribute value.
 */
<strong>#list</strong> {
  attrs:  "bgcolor" color;
  logic: {
    @members.each_with_index do |member, i|
      color = i % 2 == 0 ? '#FFCCCC' : '#CCCCFF';
      _stag    # start tag
      _cont    # content
      _etag    # end tag
    end
  }
}

/*
 * an element which is marked by 'id="mark:name"':
 *  - print value of member[:name] as content of the element.
 */
<strong>#name</strong> {
  value: member[:name];
}

/*
 * an element marked by 'id="mark:email"':
 *  - print value of member[:email] as contentn of the element. 
 *  - print "mailto:" and member[:email] as href attribute value.
 */
<strong>#email</strong> {
  value: member[:email];
  attrs: "href" "mailto:#{member[:email]}";
}
</pre>
<p>(Don't forget the semicolon at the end of line especially for Ruby user!)
</p>
<p>You will find that there is no HTML tag in the presentation logic and no logic in the presentation data.
That is to say, Kwartz can separate presentation logic from presentation data.
</p>
<div class="terminal_caption">
compilation</div>
<pre class="terminal">$ kwartz -p example2.plogic example2.html &gt; example2.rhtml
</pre>
<a name="example2.expected"></a>
<div class="program_caption">
output script</div>
<pre class="program">&lt;table&gt;
<strong>&lt;%     @members.each_with_index do |member, i| %&gt;</strong>
<strong>&lt;%       color = i % 2 == 0 ? '#FFCCCC' : '#CCCCFF'; %&gt;</strong>
 &lt;tr bgcolor="<strong>&lt;%= color %&gt;</strong>"&gt;
  &lt;td&gt;<strong>&lt;%= member[:name] %&gt;</strong>&lt;/td&gt;
  &lt;td&gt;
   &lt;a href="<strong>&lt;%= "mailto:#{member[:email]}" %&gt;</strong>"&gt;<strong>&lt;%= member[:email] %&gt;</strong>&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
<strong>&lt;%     end %&gt;</strong>
&lt;/table&gt;
</pre>
<br>


<a name="pattern"></a>
<h3 class="section2">Other Examples of Presentation Logic</h3>
<p>Kwartz enables you to write complex presentation logic natulally.
This section shows some examples.
See <a href="p-pattern.html">Presentation Pattern Catalog</a> for details.
</p>
<ul type="disc">
<li>Iterate an element.
<pre class="program">#list {
  logic: {
    for member in @members
      _stag
      _cont
      _etag
    end
  }
}
</pre>
   Or
<pre class="program">#list {
  logic: {
    for member in @members
      _elem     # equivarent to _stag + _cont + _etag
    end
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Iterate only contents. This is useful for &lt;dl&gt;&lt;/dl&gt;.
<pre class="program">#list {
  logic: {
    _stag
    for member in @members
      _cont
    end
    _etag
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Replace content of element by expression value.
<pre class="program">#list {
  logic: {
    _stag
    print expr
    _etag
  }
}
</pre>
   Or
<pre class="program">#list {
  value: expr;
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Replace element by exression value
<pre class="program">#list {
  logic: {
    print expr
  }
}
</pre>
    Or
<pre class="program">#list {
  elem:  expr;
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Delete start-tag and end-tag, and leaves content only.
<pre class="program">#list {
  logic: {
    _cont
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Delete elemnt. This is useful for delete dummy data.
<pre class="program">#list {
  logic: {
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Replace element with other element.
<pre class="program">#list {
  logic: {
    _element(foo)  # expand other element marked with name 'foo'
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Replace element with other element's content.
<pre class="program">#list {
  logic: {
    _content(foo)  # expand content of other element
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>Include complex presentation logics.
<pre class="program">#list {
  logic: {
    i = 0
    for member in @members
      i += 1
      if i % 2 == 0
        color = '#FFCCCC'
      else
        color = '#CCCCFF'
      end
      _elem    # '_elem' is equivarent to _stag + _cont + _etag
    end
  }
}
</pre>
</li>
</ul>
<p>It is very important that tag/attribute names don't appear in presentation logic at all.
This way, you don't need to change presentation logic files even if the tag/attribute names are changed in the presentation data.
</p>
<p>Kwartz separates presentation logic from presentation data and main program.
</p>
<br>


<br>


<a name="detail"></a>
<h2 class="section1">Features Detail</h2>
<a name="ruleset"></a>
<h3 class="section2">RuleSet and Properties</h3>
<p>Format of presentation logic in Kwartz is similar to CSS (Cascading Style Sheet).
</p>
<ul type="disc">
<li>Presentation logic file is a set of Ruleset.
</li>
<li>Ruleset is a pair of selector and declarations.
</li>
<li>Declaration is a pair of property name and value.
</li>
</ul>
<p>The following rules are available in presesntation logic file.
These are similar to CSS. If you are familiar with CSS, you'll be so with Kwartz.
</p>
<dl class="dl3">
<dt class="dt3"><b>
stag: <em>expr</em>; </b></dt>
<dd class="dd3">
	Replace start-tag by expression value.
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
etag: <em>expr</em>; </b></dt>
<dd class="dd3">
	Replace end-tag by expression value.
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
elem: <em>expr</em>; </b></dt>
<dd class="dd3">
	Replace elemnt by expression value.
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
cont: <em>expr</em>; </b></dt>
<dd class="dd3">
	Replace content of element by expressin value.
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
value: <em>expr</em>; </b></dt>
<dd class="dd3">
	Equivarent to <code>cont: <em>expr</em></code>.
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
attrs: 'attrname' <em>expr</em>; </b></dt>
<dd class="dd3">
	Replace attribute value by expression.
	The following is an example to specify some attributes.
<pre class="program">#foo {
  attrs:  'href'  item[:url],
	  'id'    item[:id],
          'class' classname;
}
</pre>
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
append: <em>expr</em>; </b></dt>
<dd class="dd3">
	Append expression value to tail of tag.
	This is used especially to add 'checked="checked"', 'selected="selected"'
	into the form control tag.
<pre class="program">#checkbox1 {
  append:  member[:age] &gt; 18 ? ' checked="checked"' : '';
}
#select_options {
  append:  option[:value] == current_val ? ' selected="selected"' : '';
}
</pre>
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
remove:  'attr1', 'attr2', 'attr3'; </b></dt>
<dd class="dd3">
	Remove the attributes from the element.
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><b>
logic: { ... } </b></dt>
<dd class="dd3">
	Logic of the element.
</dd>
</dl>
<p>'stag:' and 'elem:' are useful especially for Ruby on Rails.
The following is an examle to use Kwartz in Ruby on Rails.
</p>
<a name="form1.html"></a>
<div class="program_caption">
presentation data (form1.html)</div>
<pre class="program">&lt;form <strong>id="form"</strong>&gt;
  Name: &lt;input type="text" <strong>id="member_name"</strong>&gt;&lt;br&gt;
  Birthday: &lt;select <strong>id="member_birth"</strong>&gt;
              &lt;option&gt; - &lt;/option&gt;
            &lt;/select&gt;&lt;br&gt;
 &lt;input type="submit" <strong>id="submit"</strong>&gt;
&lt;/form&gt;
</pre>
<a name="form1.plogic"></a>
<div class="program_caption">
presentation logic (form1.plogic)</div>
<pre class="program"><strong>#form</strong> {
  <strong>stag:</strong>  start_form_tag :action=&gt;'new';
}
<strong>#member_name</strong> {
  <strong>elem:</strong>  text_field 'member', 'name';
}
<strong>#member_birth</strong> {
  <strong>elem:</strong>  date_select 'member', birth';
}
<strong>#submit</strong> {
  <strong>elem:</strong>  submit_to 'Submit';
}
</pre>
<a name="form1.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz -p form1.plogic form1.html
<strong>&lt;%= start_form_tag :action=&gt;'new' %&gt;</strong>
  Name: <strong>&lt;%= text_field 'member', 'name' %&gt;</strong>&lt;br&gt;
  Birthday: <strong>&lt;%= date_select 'member', birth' %&gt;</strong>&lt;br&gt;
 <strong>&lt;%= submit_to 'Submit' %&gt;</strong>
&lt;/form&gt;
</pre>
<br>


<a name="directives"></a>
<h3 class="section2">Directives</h3>
<p>Presentation logic may be embedded into presentation data in Kwartz.
You can choose to separate or not to sepearate presentation logic from presentation data.
</p>
<p>The reason to provide both solutions (separate or not) is <strong>choosability</strong>.
Some preferes to separate presentation logic from presentaion data, and others may
prefere to mix them.
Both approaches have own advantages and disadvantages.
Thus it is the user who determine which solution to adopt.
Kwartz provides both approaches and you can select which to use.
Kwartz doesn't enforce you to adopt a solution.
</p>
<p>To embed presentation logic into presentation data, use directives.
Directive is a command to embed presentation logic into presentation data.
In Kwartz, 'title' attributes<sup>(<a href="#fnref:4" name="fnlink:4">*4</a>)</sup> are used to describe directives.
</p>
<p>The following is an example to use directives.
</p>
<ul type="disc">
<li>Directive <code>title="for <em>var</em> in <em>list</em>"</code> means to iterate the element.
</li>
<li>Directive <code>title="value: <em>expression</em>"</code> means to print value of expression as content of the element.
</li>
<li>Directive <code>title="dummy:"</code> means that the element is a dummy and is not printed out.
</li>
</ul>
<a name="directive1.html"></a>
<div class="program_caption">
Presentation Data(directive1.html):</div>
<pre class="program">&lt;table&gt;
  &lt;tr <strong>title="for member in @members"</strong>&gt;
    &lt;td <strong>title="value: member.name"</strong>&gt;foo&lt;/td&gt;
    &lt;td&gt;
      &lt;a href="mailto:&lt;%= member.email %&gt;"
         title="<strong>value: member.email</strong>"&gt;foo@mai.com&lt;/a&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr <strong>title="dummy:"</strong>&gt;
    &lt;td&gt;bar&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:bar@mail.org"&gt;bar@mail.org&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr <strong>title="dummy:"</strong>&gt;
    &lt;td&gt;baz&lt;/td&gt;
    &lt;td&gt;&lt;a href="mailto:baz@mail.net"&gt;baz@mail.net&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
</pre>
<div class="terminal_caption">
Compile:</div>
<pre class="terminal">$ kwartz -l eruby  directive1.html &gt; directive1.rhtml
</pre>
<a name="directive1.expected"></a>
<div class="program_caption">
Output script:</div>
<pre class="program">&lt;table&gt;
<strong>&lt;% for member in @members do %&gt;</strong>
  &lt;tr&gt;
    &lt;td&gt;<strong>&lt;%= member.name %&gt;</strong>&lt;/td&gt;
    &lt;td&gt;
      &lt;a href="mailto:<strong>&lt;%= member.email %&gt;</strong>"&gt;<strong>&lt;%= member.email %&gt;</strong>&lt;/a&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
<strong>&lt;% end %&gt;</strong>
&lt;/table&gt;
</pre>
<p>If the first character of target attribute is a space, Kwartz recognize it as non-directive<sup>(<a href="#fnref:5" name="fnlink:5">*5</a>)</sup>.
</p>
<a name="directive2.html"></a>
<div class="program_caption">
presentation data (directive2.html)</div>
<pre class="program">&lt;span <strong>title="value: expr1"</strong>&gt;foo&lt;/span&gt;
&lt;span <strong>title=" value: expr2"</strong>&gt;bar&lt;/span&gt;
</pre>
<a name="directive2.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz directive2.html
&lt;span&gt;<strong>&lt;%= expr1 %&gt;</strong>&lt;/span&gt;
&lt;span <strong>title="value: expr2"</strong>&gt;bar&lt;/span&gt;
</pre>
<p>Directives are different in each target language.
For example, foreach loop is 'for item in list' in eRuby, 'foreach($list as $item)' in PHP, 'forEach(item in list)' in JSTL.
See reference manual for details about directives.
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:4" href="#fnlink:4">*4</a>)</dt>
  <dd>It is able to change attribute name by command-line option '--dattr=name' or configuration option PROPRERTY_DATTR.</dd>
  <dt>(<a name="fnref:5" href="#fnlink:5">*5</a>)</dt>
  <dd>This spec may change in the future if I get have better idea.</dd>
 </dl>
</div>
<br>


<a name="escape"></a>
<h3 class="section2">Escape</h3>
<p>Kwartz supports Automatic-escape and Partial-escape/unescape.
</p>
<ul type="disc">
<li>If command-line option '<code>-e</code>' is specified,  values of '<code>value: <em>expr</em></code>'
   are escaped. (Automatic-escape)
</li>
<li>'<code>Value: <em>expr</em></code>' always escapes value even when '<code>-e</code>' is not specified. (Partial-escape)
</li>
<li>'<code>VALUE: <em>expr</em></code>' always doesn't escapes value even when '<code>-e</code>' is specified. (Partial-unescape)
</li>
</ul>
<a name="escape1.html"></a>
<div class="program_caption">
presentation Data (escape1.html):</div>
<pre class="program">&lt;tr&gt;
  &lt;td id="mark:val1"&gt;foo&lt;/td&gt;
  &lt;td id="mark:val2"&gt;bar&lt;/td&gt;
  &lt;td id="mark:val3"&gt;baz&lt;/td&gt;
&lt;/tr&gt;
</pre>
<a name="escape1.plogic"></a>
<div class="program_caption">
presentation logic (escape1.plogic)</div>
<pre class="program">#val1 {
  <strong>value:</strong> expr;
}
#val2 {
  <strong>Value:</strong> expr;
}
#val3 {
  <strong>VALUE:</strong> expr;
}
</pre>
<a name="escape1.expected"></a>
<div class="terminal_caption">
compile without '<code>-e</code>' option.</div>
<pre class="terminal">$ kwartz -p escape1.plogic escape1.html
&lt;tr&gt;
  &lt;td&gt;&lt;%= expr %&gt;&lt;/td&gt;
  &lt;td&gt;&lt;%=h expr %&gt;&lt;/td&gt;
  &lt;td&gt;&lt;%= expr %&gt;&lt;/td&gt;
&lt;/tr&gt;
</pre>
<a name="escape1e.expected"></a>
<div class="terminal_caption">
comple with '<code>-e</code>' option.</div>
<pre class="terminal">$ kwartz <strong>-e</strong> -p escape1.plogic escape1.html
&lt;tr&gt;
  &lt;td&gt;<strong>&lt;%=h expr %&gt;</strong>&lt;/td&gt;
  &lt;td&gt;<strong>&lt;%=h expr %&gt;</strong>&lt;/td&gt;
  &lt;td&gt;<strong>&lt;%= expr %&gt;</strong>&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>In the same way, '<code>Stag:</code>', '<code>Etag:</code>', '<code>Elem:</code>',
'<code>Cont:</code>', '<code>Attrs:</code>', and '<code>Append:</code>' properties are
always escaped, '<code>STAG:</code>', '<code>ETAG:</code>', '<code>ELEM:</code>',
'<code>CONT:</code>', '<code>ATTRS:</code>', and '<code>APPEND:</code>' properties are
never escaped.
</p>
<p>Escape function or method is different for each tareget language.
'h()' is used in eRuby and 'htmlspecialchars()' in PHP.
JSTL prints escaped value in default.
</p>
<p>Directives <code>title="Value: <em>expr</em>"</code>, <code>title="Attr: '<em>name</em>' <em>expr</em>"</code>, and <code>title="Append: <em>expr</em>"</code> always escape expression value even when the command-line option '<code>-e</code>' is not specified.
</p>
<p>Directives <code>title="VALUE: <em>expr</em>:"</code>, <code>title="ATTR: '<em>name</em>' <em>expr</em>"</code>, and <code>title="APPEND: <em>expr</em>"</code> doesn't escape expression value even when the command-line option '<code>-e</code>' is specified.
</p>
<p>Configuration option PROPERTY_ESCAPE in 'kwartz/config.rb' determines whether values are escaped or not in default.
If this is true then Kwartz will escape values in default.
</p>
<br>


<a name="langs"></a>
<h3 class="section2">Multi-language</h3>
<p>Kwartz-ruby now supports the following programming language.
</p>
<ul type="disc">
<li>Ruby, eRuby(ERB, Erubis)
</li>
<li>PHP
</li>
<li>JSP (JSTL 1.1 and 1.2)
</li>
<li>ePerl [experimental]
</li>
</ul>
<p>Presentation logics must be described in each target language.
It means that if you have wrote presentation logics in Ruby, they were not reusable
for PHP project (but you can get full-power of Ruby in presentation logic).
</p>
<p>The followings are examples of Ruby, eRuby, PHP, JSP, and ePerl.
</p>
<a name="table1.html"></a>
<div class="program_caption">
table1.html</div>
<pre class="program">&lt;html&gt;
  &lt;body&gt;
  
    &lt;table&gt;
      &lt;tr bgcolor="#CCCCFF" <strong>id="mark:row"</strong>&gt;
        &lt;td <strong>id="mark:name"</strong>&gt;Foo&lt;/td&gt;
        &lt;td <strong>id="mark:mail"</strong>&gt;foo@mail.com&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr bgcolor="#FFCCCC" <strong>id="dummy:row1"</strong>&gt;
        &lt;td&gt;Bar&lt;/td&gt;
        &lt;td&gt;bar@mail.net&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr bgcolor="#CCCCFF" <strong>id="dummy:row2"</strong>&gt;
        &lt;td&gt;Baz&lt;/td&gt;
        &lt;td&gt;baz@mail.org&lt;/td&gt;
      &lt;/tr&gt;
    &lt;/table&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<a name="table1.ruby.plogic"></a>
<div class="program_caption">
table1.ruby.plogic</div>
<pre class="program">#row {
  attrs:  "bgcolor" color;
  logic: {
    @list.each_with_index do |user, i|
      color = i % 2 == 1 ? '#FFCCCC' : '#CCCCFF'
      _elem
    end
  }
}

#name {
  Value:  user[:name];
}

#mail {
  value:  user[:mail];
}
</pre>
<a name="table1.php.plogic"></a>
<div class="program_caption">
table1.php.plogic</div>
<pre class="program">#row {
  attrs:  "bgcolor" $color;
  logic: {
    $i = 0;
    foreach ($list as $user) {
      $color = ++$i % 2 == 0 ? '#FFCCCC' : '#CCCCFF';
      _elem();
    }
  }
}

#name {
  Value:  $user['name'];
}

#mail {
  value:  $user['mail'];
}
</pre>
<a name="table1.jstl.plogic"></a>
<div class="program_caption">
table1.jstl.plogic</div>
<pre class="program">#row {
  attrs:  "bgcolor" color;
  logic: {
    &lt;c:forEach var="user" items="${list}" varStatus="loop"&gt;
      &lt;c:set var="color" value="${loop.index % 2 == 0 ? '#FFCCCC' : '#CCCCFF'}"/&gt;
      _elem
    &lt;/c:forEach&gt;
  }
}

#name {
  Value:  user.name;
}

#mail {
  value:  user.mail;
}
</pre>
<a name="table1.eperl.plogic"></a>
<div class="program_caption">
table1.eperl.plogic</div>
<pre class="program">#row {
  attrs:  "bgcolor" $color;
  logic: {
    $i = 0;
    foreach ($user in @list) {
      $color = ++$i % 2 == 0 ? '#FFCCCC' : '#CCCCFF';
      _elem();
    }
  }
}

#name {
  Value:  $user{'name'};
}

#mail {
  value:  $user{'mail'};
}
</pre>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz -l eruby    -p table1.ruby.plogic  table1.html  &gt; table1.rhtml
$ kwartz -l ruby     -p table1.ruby.plogic  table1.html &gt; table1.rb
$ kwartz -l pierubis -p table1.ruby.plogic  table1.html &gt; table1.pierubis
$ kwartz -l php      -p table1.php.plogic   table1.html &gt; table1.php
$ kwartz -l jstl     -p table1.jstl.plogic  table1.html &gt; table1.jsp
$ kwartz -l eperl    -p table1.eperl.plogic table1.html &gt; table1.iphtml
</pre>
<a name="table1.rhtml"></a>
<div class="program_caption">
output script (table1.rhtml)</div>
<pre class="program">&lt;html&gt;
  &lt;body&gt;
  
    &lt;table&gt;
<strong>&lt;%     @list.each_with_index do |user, i| %&gt;</strong>
<strong>&lt;%       color = i % 2 == 1 ? '#FFCCCC' : '#CCCCFF' %&gt;</strong>
      &lt;tr bgcolor="<strong>&lt;%= color %&gt;</strong>"&gt;
        &lt;td&gt;<strong>&lt;%=h user[:name] %&gt;</strong>&lt;/td&gt;
        &lt;td&gt;<strong>&lt;%= user[:mail] %&gt;</strong>&lt;/td&gt;
      &lt;/tr&gt;
<strong>&lt;%     end %&gt;</strong>
    &lt;/table&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<a name="table1.rb"></a>
<div class="program_caption">
output script (table1.rb)</div>
<pre class="program">_buf = ""; _buf &lt;&lt; "&lt;html&gt;
  &lt;body&gt;
  
    &lt;table&gt;\n";
    <strong>@list.each_with_index do |user, i|</strong>
      <strong>color = i % 2 == 1 ? '#FFCCCC' : '#CCCCFF'</strong>
_buf &lt;&lt; "      &lt;tr bgcolor=\""; _buf &lt;&lt; (color).to_s; _buf &lt;&lt; "\"&gt;
        &lt;td&gt;"; <strong>_buf &lt;&lt; ERB::Util.h(user[:name]);</strong> _buf &lt;&lt; "&lt;/td&gt;
        &lt;td&gt;"; <strong>_buf &lt;&lt; (user[:mail]).to_s;</strong> _buf &lt;&lt; "&lt;/td&gt;
      &lt;/tr&gt;\n";
    <strong>end</strong>
_buf &lt;&lt; "    &lt;/table&gt;

 &lt;/body&gt;
&lt;/html&gt;\n";
; _buf
</pre>
<a name="table1.pierubis"></a>
<div class="program_caption">
output script (table1.pierubis)</div>
<pre class="program">&lt;html&gt;
  &lt;body&gt;
  
    &lt;table&gt;
<strong>&lt;?rb     @list.each_with_index do |user, i| ?&gt;</strong>
<strong>&lt;?rb       color = i % 2 == 1 ? '#FFCCCC' : '#CCCCFF' ?&gt;</strong>
      &lt;tr bgcolor="<strong>$!{color}</strong>"&gt;
        &lt;td&gt;<strong>${user[:name]}</strong>&lt;/td&gt;
        &lt;td&gt;<strong>$!{user[:mail]}</strong>&lt;/td&gt;
      &lt;/tr&gt;
<strong>&lt;?rb     end ?&gt;</strong>
    &lt;/table&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<a name="table1.php"></a>
<div class="program_caption">
output script (table1.php)</div>
<pre class="program">&lt;html&gt;
  &lt;body&gt;
  
    &lt;table&gt;
<strong>&lt;?php     $i = 0; ?&gt;</strong>
<strong>&lt;?php     foreach ($list as $user) { ?&gt;</strong>
<strong>&lt;?php       $color = ++$i % 2 == 0 ? '#FFCCCC' : '#CCCCFF'; ?&gt;</strong>
      &lt;tr bgcolor="<strong>&lt;?php echo $color; ?&gt;</strong>"&gt;
        &lt;td&gt;<strong>&lt;?php echo htmlspecialchars($user['name']); ?&gt;</strong>&lt;/td&gt;
        &lt;td&gt;<strong>&lt;?php echo $user['mail']; ?&gt;</strong>&lt;/td&gt;
      &lt;/tr&gt;
<strong>&lt;?php     } ?&gt;</strong>
    &lt;/table&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<a name="table1.jsp"></a>
<div class="program_caption">
output script (JSTL 1.2)</div>
<pre class="program">&lt;%@ taglib prefix="c"  uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;html&gt;
  &lt;body&gt;
  
    &lt;table&gt;
    <strong>&lt;c:forEach var="user" items="${list}" varStatus="loop"&gt;</strong>
      <strong>&lt;c:set var="color" value="${loop.index % 2 == 0 ? '#FFCCCC' : '#CCCCFF'}"/&gt;</strong>
      &lt;tr bgcolor="<strong>${color}</strong>"&gt;
        &lt;td&gt;<strong>${user.name}</strong>&lt;/td&gt;
        &lt;td&gt;<strong>${user.mail}</strong>&lt;/td&gt;
      &lt;/tr&gt;
    <strong>&lt;/c:forEach&gt;</strong>
    &lt;/table&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<a name="table1.iphtml"></a>
<div class="program_caption">
output script (ePerl)</div>
<pre class="program">&lt;html&gt;
  &lt;body&gt;
  
    &lt;table&gt;
<strong>&lt;?     $i = 0; !&gt;</strong>
<strong>&lt;?     foreach ($user in @list) { !&gt;</strong>
<strong>&lt;?       $color = ++$i % 2 == 0 ? '#FFCCCC' : '#CCCCFF'; !&gt;</strong>
      &lt;tr bgcolor="<strong>&lt;?= $color !&gt;</strong>"&gt;
        &lt;td&gt;<strong>&lt;?= encode_entities($user{'name'}) !&gt;</strong>&lt;/td&gt;
        &lt;td&gt;<strong>&lt;?= $user{'mail'} !&gt;</strong>&lt;/td&gt;
      &lt;/tr&gt;
<strong>&lt;?     } !&gt;</strong>
    &lt;/table&gt;

 &lt;/body&gt;
&lt;/html&gt;
</pre>
<br>


<a name="span"></a>
<h3 class="section2">Span Tag Deletion</h3>
<p>Kwartz regards span tags which contain only directives as dummy tags and delete them automatically when command-line option '--delspan' is specified.
</p>
<a name="delspan1.html"></a>
<div class="program_caption">
presentation data (delspan1.html)</div>
<pre class="program">&lt;h1&gt;&lt;span <strong>id="mark:title"</strong>&gt;title&lt;/span&gt;&lt;/h1&gt;

Hello &lt;span <strong>title="value: user"</strong>&gt;World&lt;/span&gt;!
</pre>
<a name="delspan1.plogic"></a>
<div class="program_caption">
presentation logic (delspan1.plogic)</div>
<pre class="program">#title {
  value: title;
}
</pre>
<a name="delspan1.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz -p delspan1.plogic <strong>--delspan</strong> delspan1.html
&lt;h1&gt;<strong>&lt;%= title %&gt;</strong>&lt;/h1&gt;

Hello <strong>&lt;%= user %&gt;</strong>!
</pre>
<p>The span tags are not removed when they have other attributes.
</p>
<a name="delspan2.html"></a>
<div class="program_caption">
presentation data (delspan2.html)</div>
<pre class="program">Hello &lt;span <strong>title="value: user" style="color:black"</strong>&gt;World&lt;/span&gt;!
</pre>
<a name="delspan2.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz <strong>--delspan</strong> delspan2.html
Hello <strong>&lt;span style="color:black"&gt;</strong>&lt;%= user %&gt;<strong>&lt;/span&gt;</strong>!
</pre>
<br>


<a name="import-plogic"></a>
<h3 class="section2">Import Presentation Logic File</h3>
<p>'<code>@imort "filename.plogic"</code>' imports filename.plogic.
This is useful to share common presentation logic in many files.
</p>
<a name="link_to2.plogic"></a>
<div class="program_caption">
link_to.plogic</div>
<pre class="program"><strong>#link_to_new</strong> {
  elem:  start_link_tag :action=&gt;'new';
}
<strong>#link_to_show</strong> {
  elem:  start_link_tag :action=&gt;'show', :id=&gt;@member;
}
<strong>#link_to_edit</strong> {
  elem:  start_link_tag :action=&gt;'edit', :id=&gt;@member;
}
<strong>#link_to_list</strong> {
  elem:  start_link_tag :action=&gt;'list';
}
<strong>#link_to_destroy</strong> {
  stag:  start_link_tag({:action=&gt;'destroy', :id=&gt;@member}, :confirm=&gt;'Are you sure?');
}
</pre>
<a name="show2.html"></a>
<div class="program_caption">
show.html</div>
<pre class="program">&lt;p&gt;
 Name: &lt;span id="mark:name"&gt;foo&lt;/span&gt; &lt;br&gt;
 Email: &lt;span id="mark:email"&gt;foo@mail.com&lt;/span&gt; &lt;br&gt;
&lt;/p&gt;
&lt;a href="#" <strong>id="link_to_edit"</strong>&gt;Edit this member&lt;/a&gt; |
&lt;a href="#" <strong>id="link_to_new"</strong>&gt;Create new member&lt;/a&gt; |
&lt;a href="#" <strong>id="link_to_list"</strong>&gt;Return to list&lt;/a&gt;
</pre>
<div class="program_caption">
show.plogic</div>
<pre class="program"><strong>@import 'link_to.plogic';</strong>

#name {
  Value: @member.name;
}
#email {
  Value: @member.email;
}
</pre>
<a name="show2.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz -p show.plogic show.html
&lt;p&gt;
 Name: &lt;span&gt;&lt;%=h @member.name %&gt;&lt;/span&gt; &lt;br&gt;
 Email: &lt;span&gt;&lt;%=h @member.email %&gt;&lt;/span&gt; &lt;br&gt;
&lt;/p&gt;
&lt;%= start_link_tag :action=&gt;'edit', :id=&gt;@member %&gt; |
&lt;%= start_link_tag :action=&gt;'new' %&gt; |
&lt;%= start_link_tag :action=&gt;'list' %&gt;
</pre>
<br>


<a name="import-elem"></a>
<h3 class="section2">Import Elements in Other Files</h3>
<p>Command-line option '-i <em>filename,...</em>' imports element definitions form other files.
</p>
<a name="form.html"></a>
<div class="program_caption">
form.html</div>
<pre class="program">&lt;form&gt;
 &lt;div <strong>id="mark:form_content"</strong>&gt;
  <strong>Name: &lt;input type="text"&gt;&lt;br&gt;</strong>
  <strong>Password: &lt;input type="password"&gt;&lt;br&gt;</strong>
 &lt;/div&gt;
 &lt;input type="submit"&gt;
&lt;/form&gt;
</pre>
<a name="new.html"></a>
<div class="program_caption">
new.html</div>
<pre class="program">&lt;form action="/new"&gt;
  &lt;div <strong>id="mark:placeholder"</strong>&gt;&lt;/div&gt;
  &lt;input type="submit" value="Create"&gt;
&lt;/form&gt;
</pre>
<a name="new.plogic"></a>
<div class="program_caption">
new.plogic</div>
<pre class="program">/* use element which is defined other file */
<strong>#placeholder</strong> {
  logic: {
    <strong>_content(form_content)</strong>
  }
}
</pre>
<a name="new.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz <strong>-i form.html</strong> -p new.plogic new.html
&lt;form action="/new"&gt;
  <strong>Name: &lt;input type="text"&gt;&lt;br&gt;</strong>
  <strong>Password: &lt;input type="password"&gt;&lt;br&gt;</strong>
  &lt;input type="submit" value="Create"&gt;
&lt;/form&gt;
</pre>
<br>


<a name="extract"></a>
<h3 class="section2">Extract Element</h3>
<p>Command option '-X <em>name</em>' extracts element marked as <em>name</em>
and command option '-x <em>name</em>' extracts content of element.
</p>
<a name="show.html"></a>
<div class="program_caption">
show.html</div>
<pre class="program">&lt;html&gt;
 &lt;body&gt;
  &lt;div <strong>id="mark:content"</strong>&gt;
   &lt;h1&gt;Show&lt;/h1&gt;
   &lt;p&gt;Name: &lt;span id="mark:name"&gt;foo&lt;/span&gt;&lt;/p&gt;
   &lt;p&gt;Email: &lt;span id="mark:email"&gt;foo@mail.com&lt;/span&gt;&lt;/p&gt;
  &lt;/div&gt;
 &lt;/body&gt;
&lt;/html&gt;
</pre>
<a name="show.plogic"></a>
<div class="program_caption">
show.plogic</div>
<pre class="program">#name {
  value: user.name;
}
#email {
  value: user.email;
}
</pre>
<div class="terminal_caption">
compile with '-X'</div>
<pre class="terminal">$ kwartz <strong>-X content</strong> -p show.plogic show.html
  &lt;div&gt;
   &lt;h1&gt;Show&lt;/h1&gt;
   &lt;p&gt;Name: &lt;span&gt;&lt;%= user.name %&gt;&lt;/span&gt;&lt;/p&gt;
   &lt;p&gt;Email: &lt;span&gt;&lt;%= user.email %&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;/div&gt;
</pre>
<a name="test_show_cont.expected"></a>
<div class="terminal_caption">
compile with '-x'</div>
<pre class="terminal">$ kwartz <strong>-x content</strong> -p show.plogic show.html
   &lt;h1&gt;Show&lt;/h1&gt;
   &lt;p&gt;Name: &lt;span&gt;&lt;%= user.name %&gt;&lt;/span&gt;&lt;/p&gt;
   &lt;p&gt;Email: &lt;span&gt;&lt;%= user.email %&gt;&lt;/span&gt;&lt;/p&gt;
</pre>
<br>


<a name="print-statement"></a>
<h3 class="section2">Print Statement</h3>
<p>Print statement is available in 'logic:' property.
</p>
<a name="print-stmt.html"></a>
<div class="program_caption">
print-stmt.html</div>
<pre class="program">&lt;ul&gt;
  &lt;li id="items"&gt;foo&lt;/li&gt;
&lt;/ul&gt;
</pre>
<a name="print-stmt.eruby.plogic"></a>
<div class="program_caption">
print-stmt.eruby.plogic</div>
<pre class="program">#items {
  logic: {
    for item in list
      _stag
      <strong>print item</strong>
      _etag
    end
  }
}
</pre>
<a name="print-stmt.eruby.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz -l eruby -p print-stmt.eruby.plogic print-stmt.html
&lt;ul&gt;
&lt;%     for item in list %&gt;
  &lt;li id="items"&gt;<strong>&lt;%= item %&gt;</strong>&lt;/li&gt;
&lt;%     end %&gt;
&lt;/ul&gt;
</pre>
<a name="print-stmt.php.plogic"></a>
<div class="program_caption">
print-stmt.php.plogic</div>
<pre class="program">#items {
  logic: {
    foreach ($list as $item) {
      _stag();
      <strong>print($item);</strong>
      _etag();
    }
  }
}
</pre>
<a name="print-stmt.php.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz -l php -p print-stmt.php.plogic print-stmt.html
&lt;ul&gt;
&lt;?php     foreach ($list as $item) { ?&gt;
  &lt;li id="items"&gt;<strong>&lt;?php echo $item; ?&gt;</strong>&lt;/li&gt;
&lt;?php     } ?&gt;
&lt;/ul&gt;
</pre>
<a name="print-stmt.jstl.plogic"></a>
<div class="program_caption">
print-stmt.jstl.plogic</div>
<pre class="program">#items {
  logic: {
    &lt;c:forEach var="item" items="${list}"&gt;
      _stag
      <strong>print item</strong>
      _etag
    &lt;/c:forEach&gt;
  }
}
</pre>
<a name="print-stmt.jstl12.expected"></a>
<div class="terminal_caption">
compile (JSTL 1.2)</div>
<pre class="terminal">$ kwartz -l jstl -p print-stmt.jstl.plogic print-stmt.html
&lt;%@ taglib prefix="c"  uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;ul&gt;
    &lt;c:forEach var="item" items="${list}"&gt;
  &lt;li id="items"&gt;<strong>${item}</strong>&lt;/li&gt;
    &lt;/c:forEach&gt;
&lt;/ul&gt;
</pre>
<a name="print-stmt.jstl11.expected"></a>
<div class="terminal_caption">
compile (JSTL 1.1)</div>
<pre class="terminal">$ kwartz -l jstl -p print-stmt.jstl.plogic --jstl=1.1 print-stmt.html
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;ul&gt;
    &lt;c:forEach var="item" items="${list}"&gt;
  &lt;li id="items"&gt;<strong>&lt;c:out value="${item}"/&gt;</strong>&lt;/li&gt;
    &lt;/c:forEach&gt;
&lt;/ul&gt;
</pre>
<p>It is recommended to use 'elem:', 'stag:', 'etag:', 'cont:', or 'value:' instead of
print statement because they can escape or unescape exression value.
</p>
<br>


<a name="begin"></a>
<h3 class="section2">Add Code at Beginning/End of Document</h3>
<p>'#DOCUMENT' is a special selector which represents the document.
In '#DOCUMENT', properties 'begin:' and 'end:' are available to add codes at beginning/end of document.
</p>
<a name="document-test.html"></a>
<div class="program_caption">
document-test.html</div>
<pre class="program">&lt;html&gt;
 &lt;body&gt;hello&lt;/body&gt;
&lt;/html&gt;
</pre>
<a name="document-test.plogic"></a>
<div class="program_caption">
document-test.plogic</div>
<pre class="program"><strong>#DOCUMENT</strong> {
  <strong>begin:</strong> {
    title = _context[:title]
    user  = _context[:user]
  }
  <strong>end:</strong> {
    print "&lt;!--end--&gt;\n"
  }
}
</pre>
<a name="document-test.expected"></a>
<div class="terminal_caption">
compile</div>
<pre class="terminal">$ kwartz -p document-test.plogic document-test.html
<strong>&lt;%     title = _context[:title] %&gt;</strong>
<strong>&lt;%     user  = _context[:user] %&gt;</strong>
&lt;html&gt;
 &lt;body&gt;hello&lt;/body&gt;
&lt;/html&gt;
<strong>&lt;%= "&lt;!--end--&gt;\n" %&gt;</strong>
</pre>
<br>


<br>


<a name="rails"></a>
<h2 class="section1">Ruby on Rails Support</h2>
<p>This section shows how to use Kwartz with Ruby on Rails.
See 'examples/rails1' and 'examples/rails2' for examples.
</p>
<a name="helper_rails"></a>
<h3 class="section2">Support of Ruby on Rails</h3>
<p>If you want to use Kwartz with Ruby on Rails, add the following code in your 'app/controllers/application.rb' and restart web server.
</p>
<pre class="program">require 'kwartz/helper/rails'
ActionView::Base.register_template_handler('html', Kwartz::Helper::RailsTemplate)
#Kwartz::Helper::RailsTemplate.lang = 'rails'    # or eruby/ruby/erubis/pierubis
#Kwartz::Helper::RailsTemplate.pdata_suffix  = '.html'
#Kwartz::Helper::RailsTemplate.plogic_suffix = '.plogic'
#Kwartz::Helper::RailsTemplate.default_properties = { :escape=&gt;false }
#Kwartz::Helper::RailsTemplate.use_cache = true
#Kwartz::Helper::RailsTemplate.debug = true
</pre>
<p>Layout files ('app/views/layouts/xxx.{html,plogic}') are also available.
The following is an example to use layout files.
</p>
<div class="program_caption">
app/views/member/list.html</div>
<pre class="program">&lt;html&gt;
  &lt;body&gt;
    &lt;h1 <strong>id="page_title"</strong>&gt;&lt;/h1&gt;
    &lt;div <strong>id="page_content"</strong>&gt;
      &lt;ul id="mark:list"&gt;
        &lt;li id="mark:item"&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>
<div class="program_caption">
app/views/xxx/index.plogic</div>
<pre class="program">#list {
  logic: {
    @list.each do |item|
      _elem
    end
  }
}

#item {
  value:  item;
}
</pre>
<div class="program_caption">
app/views/layouts/xxx.html</div>
<pre class="program">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title id="mark:header_title"&gt;&lt;/title&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
&lt;/head&gt;
&lt;body&gt;

  &lt;h1 class="title" <strong>id="replace_content_with_content:page_title"</strong>&gt;...page title...&lt;/h1&gt;
  &lt;div <strong>id="replace_element_with_content:page_content"</strong>&gt;
    ...page content...
  &lt;/div&gt;

  &lt;p&gt;copyright&amp;copy; 2006 kuwata-lab.com all rights reserved.&lt;/p&gt;

&lt;/body&gt;
&lt;/html&gt;
</pre>
<div class="program_caption">
app/views/layouts/xxx.plogic</div>
<pre class="program">#header_title {
  cont:  'Member: ' + controller.action_name;
}
</pre>
<p>See the 'examples/rails2' directory for example of using Kwartz with Ruby on Rails.
</p>
<br>


<a name="start_link_tag"></a>
<h3 class="section2"><code>link_to()</code> method in Ruby on Rails</h3>
<p><code>link_to()</code> method in Ruby on Rails is a little incompatible with Kwartz
because you must specify link label in both presentation data and presentation logic.
It's not DRY.
</p>
<div class="program_caption">
presentation data</div>
<pre class="program">&lt;a href="#" id="mark:link_to_new"&gt;<strong>Create new recipe</strong>&lt;/a&gt;
</pre>
<div class="program_caption">
presentation logic</div>
<pre class="program">#link_to_new {
  elem:  link_to <strong>'Create new recipe'</strong>, :action=&gt;'new';
}
</pre>
<p>It is recommended to use start_link_tag() and start_remote_link_tag() instead of link_to() and link_to_remote() because they print only start tag of anchors.
</p>
<div class="program_caption">
presentation data</div>
<pre class="program">&lt;a href="#" id="mark:link_to_new"&gt;Create new recipe&lt;/a&gt;
</pre>
<div class="program_caption">
presentation logic</div>
<pre class="program">#link_to_new {
  stag:  <strong>start_link_tag</strong> :action=&gt;'new';
}
</pre>
<p>The following is the definition of start_link_tag() and start_remote_link_tag().
They are defined in Kwartz::Helper::ActionViewHelper module which is defined in
'kwartz/helper/rails.rb'.
</p>
<div class="program_caption">
definition of start_link_tag() and start_remote_link_tag()</div>
<pre class="program">module Kwartz::Helper::ActionViewHelper

  def start_link_tag(options = {}, html_options = nil, *parameters_for_method_reference)
    s = link_to('', options, html_options, *parameters_for_method_reference)
    s.sub!(/&lt;\/a&gt;\z/, '')
    s
  end
  alias anchor start_link_tag

  def start_link_remote_tag(options = {}, html_options = {})
    s = link_to_remote(options, html_options)
    s.sub!(/&lt;\/a&gt;\z/, '')
    s
  end
  alias anchor_remote start_link_remote_tag

end
</pre>
<p>You can use these helper methods if you include Kwartz::Helper::ActionViewHelper
in your ApplicationHelper module.
</p>
<div class="program_caption">
app/helpers/application_helper.rb</div>
<pre class="program"><strong>require 'kwartz/helper/rails'</strong>
module ApplicationHelper
  <strong>include Kwartz::Helper::ActionViewHelper</strong>
end
</pre>
<br>


<a name="rails-scaffold"></a>
<h3 class="section2">Scaffold Kwartz Template</h3>
<p>There is no 'generate scaffold' script for Kwartz.
Instead, use <a href="http://kwatable.rubyforge.net">Kwatable</a>.
</p>
<p><a href=""></a>Kwatable|http://kwatable.rubyforge.net}} is a script to generate severail files (SQL, DTO, Kwartz template, and so on) from table definition file.
It's more sophisticated than Rails' scaffold generating script.
</p>
<br>


<a name="rails-helper-methods"></a>
<h3 class="section2">Rails Helper Methods</h3>
<p>(Notice: this is experimental feature.)
</p>
<p>It is able to embed Rails' helper method in title attribute.
</p>
<pre class="program">## text_field, password_field
&lt;input type="text" size="10" maxsize="20" <strong>title="text_field 'user', 'name'"</strong>&gt;
 =&gt; &lt;%= text_field 'user', 'name', :size=&gt;10, :maxsize=&gt;20 %&gt;
&lt;input type="text" name="user[name]" <strong>title="text_field :size=&gt;10"</strong>&gt;
 =&gt; &lt;%= text_field "user", "name", :size=&gt;10 %&gt;
&lt;input type="text" id="user_name" size="10" <strong>title="text_field"</strong>&gt;
 =&gt; &lt;%= text_field "user", "name", :size=&gt;10 %&gt;

## link_to, link_to_remote
&lt;a href="#" <strong>title="link_to :action=&gt;'list'"</strong>&gt;Show list&lt;/a&gt;
 =&gt; &lt;%= link_to 'Show list', :action=&gt;'list' %&gt;

## start_link_tag, start_remote_link_tag
&lt;a href="#" <strong>title="start_link_tag :action=&gt;'list'"</strong>&gt;Show list&lt;/a&gt;
 =&gt; &lt;%= start_link_tag 'action'=&gt;'list' %&gt;Show list&lt;/a&gt;

## mail_to
&lt;a href="mail:www@example.com" <strong>title="mail_to"</strong>&gt;admin&lt;/a&gt;
 =&gt; &lt;%= mail_to "www@example.com", "admin" %&gt;

## form_tag
&lt;form action="show" <strong>title="form_tag :id=&gt;2"</strong>&gt; ... &lt;/form&gt;
 =&gt; &lt;%= form_tag :action=&gt;"show", :id=&gt;2 %&gt; ... &lt;/form&gt;

## submit_tag
&lt;input type="submit" value="OK" <strong>title="submit_tag"</strong>&gt;
 =&gt; &lt;%= submit_tag "OK" %&gt;

## text_area
&lt;textarea cols="30" rows="3" id="user_desc" <strong>title="text_area"</strong>&gt;&lt;/textarea&gt;
 =&gt; &lt;%= text_area "user", "desc", :cols=&gt;30, :rows=&gt;3 %&gt;
&lt;textarea cols="30" rows="3" name="user[desc]" <strong>title="text_area"</strong>&gt;&lt;/textarea&gt;
 =&gt; &lt;%= text_area "user", "desc", :cols=&gt;30, :rows=&gt;3 %&gt;

## hidden_field
&lt;input type="hidden" id="user_id" <strong>title="hidden_field"</strong>&gt;
 =&gt; &lt;%= hidden_field "user", "id" %&gt;
&lt;input type="hidden" name="user[id]" <strong>title="hidden_field"</strong>&gt;
 =&gt; &lt;%= hidden_field "user", "id" %&gt;

## check_box
&lt;input type="checkbox" id="user_chk1" <strong>title="check_box"</strong>&gt;
 =&gt; &lt;%= check_box "user", "chk1" %&gt;
&lt;input type="checkbox" name="user[chk2]" <strong>title="check_box"</strong>&gt;
 =&gt; &lt;%= check_box "user", "chk2" %&gt;

## radio_button
&lt;input type="radio" id="user_radio" value="val1" <strong>title="radio_button"</strong>&gt;
 =&gt; &lt;%= radio_button "user", "radio", "val1" %&gt;
&lt;input type="radio" name="user[radio]" value="val2" <strong>title="radio_button"</strong>&gt;
 =&gt; &lt;%= radio_button "user", "radio", "val2" %&gt;

## select, collection_select, country_select, time_zone_select, date_select, datetime_select
&lt;select name="user[birth]" <strong>title="date_select :start_year=&gt;1970"</strong>&gt;
  &lt;option value="2000"&gt;2000&lt;/option&gt;
&lt;/select&gt;
 =&gt; &lt;% date_select "user", "birth", :start_year=&gt;1970 %&gt;

## image_tag, link_image_to, link_to_image
&lt;img src="foo.gif" alt="text" width="20" heigth="10" <strong>title="image_tag :size=&gt;'30x40'"</strong>&gt;
 =&gt; &lt;%= image_tag "foo.gif", :alt=&gt;"text", :size=&gt;'30x40' %&gt;
</pre>
<br>


<br>


<a name="topics"></a>
<h2 class="section1">Other Topics</h2>
<a name="restriction1"></a>
<h3 class="section2">Restrictions around presentation logic</h3>
<p>There are several restrictions in presentation logic file.
</p>
<ul type="disc">
<li>Position in which comment '<code>/* ... */</code>' is available is limited.
   In the following example, 'value:' property will be error because
   string from 'expr;' to the end of comment is regared as argument of 'value:' property.
<pre class="program">   /* this comment is ok */
   #foo {
     /* this comment is ok */
     value:  expr;   /* this comment is NG! */
     logic: {        /* this comment will be Ruby syntax error! */
        for item in list    # ruby comment is OK in 'logic:' property
	  _stag
	  _cont
	  _etag
	end
     }
   }
</pre>
</li>
</ul>
<ul type="disc">
<li>'_stag', '_cont', '_etag', '_elem', '_element()', and '_content()' must be placed
   one in per line, because Kwartz-ruby scans 'logic:' property with regular expression
   pattern such as '/^\s*_(stag|cont|etag|element|content)(\(.*\))\s*$/' or so.
<pre class="program">   #foo {
     logic: {
       # OK
       if x &gt; 0
         _elem
       end

       # NG (parse failed)
       _elem if x &gt; 0
     }
   }
</pre>
</li>
</ul>
<ul type="disc">
<li>The number of '{' and '}' must be equal in 'logic:' property.
<pre class="program">#foo {
  logic: {
    str = "{"         # this will be parse error 
    _elem
  }
}
#bar {
  logic: {
    str = "{"         # add dummy '}' in comment!
    _elem
  }
}
</pre>
</li>
</ul>
<ul type="disc">
<li>'@import "file.plogic"' should be at the beginning of presentation logic file.
<pre class="program">   /* OK */
   @import 'file1.plogic';
   
   #foo {
   }

   /* NG */
   @import 'file2.plogic';
</pre>
</li>
</ul>
<br>


<a name="restriction2"></a>
<h3 class="section2">Restrictions around presentation data</h3>
<p>Kwartz parses presentation data file by regular expression pattern matching.
It means that Kwartz doesn't use HTML parser nor XML parser for parsing presentation data.
This approach enables Kwartz to handle any type of text file, and also brings the following restrictions to Kwartz.
</p>
<ul type="disc">
<li>Cannot omit end tag if id attribute is specified.
<pre class="program">&lt;!-- Kwartz cannot parse the following because &lt;/li&gt; is omitted. --&gt;
&lt;ul&gt;
 &lt;li id="foo"&gt;foo
&lt;/ul&gt;
</pre>
   An Element which doesn't have any content is to be written as an empty tag such as <code>&lt;foo id="..."/&gt;</code>.
</li>
</ul>
<ul type="disc">
<li>However, <code>&lt;input&gt;</code>, <code>&lt;br&gt;</code>, <code>&lt;meta&gt;</code>, <code>&lt;img&gt;</code>, and <code>&lt;hr&gt;</code> are allowed to omit end tag.
   And these doesn't have to be written as an empty tag.
<pre class="program">&lt;!-- &lt;/input/&gt; is omitted but Kwartz can parse correctly. --&gt;
&lt;input type="text" name="user" id="user"&gt;
</pre>
   Configuration option PROPERTY_NOEND lists these tag names in file 'kwartz/config.rb'.
   Upper-case and lower-case are distinguished.
</li>
</ul>
<ul type="disc">
<li>Attribute values should be surrounded with '<code>"</code>'.
<pre class="program">&lt;!-- Kwartz fails parsing because attribute value is not surrounded with '"'. --&gt;
&lt;h1 id="value:title" class=title&gt;title&lt;/h1&gt;
</pre>
</li>
</ul>
<br>


<a name="makefile"></a>
<h3 class="section2">Makefile and Rakefile</h3>
<p>The followings are examples of Makefile, Rakefile, Rantfile, and Rookbook.
</p>
<div class="program_caption">
example of Makefile</div>
<pre class="program">.SUFFIXES:  .rhtml .html .plogic

ALL    = file1.rhtml file2.rhtml file3.rhtml
LAYOUT = layout.html

default:  $(ALL)

%.rhtml:  %.html %.plogic
	kwartz -l eruby -p $*.plogic $*.html &gt; $@

file3.rhtml: file3.html file3.plogic $(LAYOUT)
	kwartz -p file3.plogic -L $(LAYOUT) file3.html &gt; file3.rhtml
</pre>
<div class="program_caption">
example of Rakefile for <a href="http://rake.rubyforge.org/">Rake</a></div>
<pre class="program">all    = ["file1.rhtml", "file2.rhtml", "file3.rhtml"]
layout = 'layout.html'

task :default =&gt; all

rule '.rhtml' =&gt; ['.html', '.plogic']           do |t|
  pdata, plogic = t.sources
  sh "kwartz -l eruby -p #{plogic} #{pdata} &gt; #{t.name}"
end

file 'file3.rhtml' =&gt; ["file3.html", "file3.plogic", layout] do |t|
  pdata, plogic, layout = t.prerequisites
  sh "kwartz -p #{plogic} -L #{layout} #{pdata} &gt; #{t.name}"
end
</pre>
<div class="program_caption">
example of Rantfile for <a href="http://make.rubyforge.org/">Rant</a></div>
<pre class="program">all    = ["file1.rhtml", "file2.rhtml", "file3.rhtml"]
layout = 'layout.html'

task :default =&gt; all

gen Rule, ".rhtml" =&gt; [".html", ".plogic"] do |t|
  pdata, plogic = t.prerequisites
  sys "kwartz -p #{plogic} #{pdata} &gt; #{t.name}"
end

file "file3.rhtml" =&gt; ["file3.html", "file3.plogic", layout] do |t|
  pdata, plogic, layout = t.prerequisites
  sys "kwartz -p #{plogic} -L #{layout} #{pdata} &gt; #{t.name}"
end
</pre>
<div class="program_caption">
example of Rookbook for <a href="http://www.rubyforge.org/projects/rook">Rook</a></div>
<pre class="program">properties:
  - layout  :  layout.html

parameters:
  - all     :  [ file1.rhtml, 'file2.rhtml', file3.rhtml ]
  - rook_product:  $(all)

recipes:

  - product:	*.rhtml
    ingreds:	[ $(1).html, $(1).plogic ]
    method*: |
        pdata, plogic = @ingreds
	sys "kwartz -p #{plogic} #{pdata} &gt; #{@product}"

  - product:	file3.rhtml
    ingres:	[ file3.html, file3.plogic, $(layout) ]
    method*: |
        pdata, plogic, layout = @ingreds
	sys "kwartz- p #{plogic} -L $(layout) #{pdata} &gt; #{@product}"
</pre>
<br>


<a name="kwartz-lib"></a>
<h3 class="section2">Use Kwartz as Library</h3>
<p>If you want to use Kwartz library in your Ruby script, use Kwartz::Main class.
</p>
<div class="program_caption">
usage of Kwartz::Main class</div>
<pre class="program"><strong>require 'kwartz'</strong>
<strong>require 'kwartz/main'</strong>

argv = %w[-p hello.plogic -L layout.html hello.html]
<strong>main = Kwartz::Main.new(argv)</strong>
<strong>output = main.execute()</strong>
File.open('hello.rhtml', 'w') { |f| f.write(output) }
</pre>
<br>


<br>



   </div>
  </blockquote>

 </body>
</html>
